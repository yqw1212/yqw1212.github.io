
<!DOCTYPE HTML>
<html lang="" >
    <head>
        <meta charset="UTF-8">
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <title>Programming SimProcedures Â· GitBook</title>
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="description" content="">
        <meta name="generator" content="GitBook 3.2.3">
        
        
        
    
    <link rel="stylesheet" href="../gitbook/style.css">

    
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-highlight/website.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-search/search.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-fontsettings/website.css">
                
            
        

    

    
        
    
        
    
        
    
        
    
        
    
        
    

        
    
    
    <meta name="HandheldFriendly" content="true"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="../gitbook/images/apple-touch-icon-precomposed-152.png">
    <link rel="shortcut icon" href="../gitbook/images/favicon.ico" type="image/x-icon">

    
    <link rel="next" href="state_plugins.html" />
    
    

    </head>
    <body>
        
<div class="book">
    <div class="book-summary">
        
            
<div id="book-search-input" role="search">
    <input type="text" placeholder="Type to search" />
</div>

            
                <nav role="navigation">
                


<ul class="summary">
    
    

    

    
        
        
    
        <li class="chapter " data-level="1.1" data-path="../">
            
                <a href="../">
            
                    
                    Introduction
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2" >
            
                <span>
            
                    
                    Introductory Errata
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.2.1" data-path="../INSTALL.html">
            
                <a href="../INSTALL.html">
            
                    
                    Installing
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.2" data-path="../HACKING.html">
            
                <a href="../HACKING.html">
            
                    
                    How to Contribute
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.3" data-path="../HELPWANTED.html">
            
                <a href="../HELPWANTED.html">
            
                    
                    What to Contribute
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.4" data-path="faq.html">
            
                <a href="faq.html">
            
                    
                    Frequently Asked Questions
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.3" >
            
                <span>
            
                    
                    Core Concepts
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.3.1" data-path="toplevel.html">
            
                <a href="toplevel.html">
            
                    
                    Top Level Interfaces
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.2" data-path="loading.html">
            
                <a href="loading.html">
            
                    
                    Loading a Binary
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.3" data-path="solver.html">
            
                <a href="solver.html">
            
                    
                    Solver Engine
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.4" data-path="states.html">
            
                <a href="states.html">
            
                    
                    Program State
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.5" data-path="pathgroups.html">
            
                <a href="pathgroups.html">
            
                    
                    Simulation Managers
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.6" data-path="simulation.html">
            
                <a href="simulation.html">
            
                    
                    Execution Engines
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.7" data-path="analyses.html">
            
                <a href="analyses.html">
            
                    
                    Analyses
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.8" data-path="be_creative.html">
            
                <a href="be_creative.html">
            
                    
                    Remarks
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.4" >
            
                <span>
            
                    
                    Built-in Analyses
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.4.1" data-path="analyses/cfg.html">
            
                <a href="analyses/cfg.html">
            
                    
                    CFG
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.2" data-path="analyses/backward_slice.html">
            
                <a href="analyses/backward_slice.html">
            
                    
                    Backward Slicing
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.3" data-path="analyses/identifier.html">
            
                <a href="analyses/identifier.html">
            
                    
                    Function Identifier
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.5" >
            
                <span>
            
                    
                    Advanced Topics
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.5.1" data-path="gotchas.html">
            
                <a href="gotchas.html">
            
                    
                    Gotchas
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.2" data-path="pipeline.html">
            
                <a href="pipeline.html">
            
                    
                    The Whole Pipeline
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.3" data-path="mixins.html">
            
                <a href="mixins.html">
            
                    
                    The Mixin Pattern
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.4" data-path="speed.html">
            
                <a href="speed.html">
            
                    
                    Optimizing Symbolic Execution
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.5" data-path="file_system.html">
            
                <a href="file_system.html">
            
                    
                    The Emulated Filesystem
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.6" data-path="ir.html">
            
                <a href="ir.html">
            
                    
                    Intermediate Representation
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.7" data-path="structured_data.html">
            
                <a href="structured_data.html">
            
                    
                    Working with Data and Conventions
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.8" data-path="claripy.html">
            
                <a href="claripy.html">
            
                    
                    Claripy
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.9" data-path="concretization_strategies.html">
            
                <a href="concretization_strategies.html">
            
                    
                    Symbolic Memory Addressing
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.10" data-path="java_support.html">
            
                <a href="java_support.html">
            
                    
                    Java Symbolic Execution
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.11" data-path="symbion.html">
            
                <a href="symbion.html">
            
                    
                    Symbion
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.6" >
            
                <span>
            
                    
                    Extending angr
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter active" data-level="1.6.1" data-path="simprocedures.html">
            
                <a href="simprocedures.html">
            
                    
                    Programming SimProcedures
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.2" data-path="state_plugins.html">
            
                <a href="state_plugins.html">
            
                    
                    Writing State Plugins
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.3" data-path="environment.html">
            
                <a href="environment.html">
            
                    
                    Extending the Environment Model
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.4" data-path="exploration_techniques.md">
            
                <span>
            
                    
                    TODO: Writing Exploration Techniques
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.5" data-path="analysis_writing.html">
            
                <a href="analysis_writing.html">
            
                    
                    Writing Analyses
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.6" data-path="angr-bf.md">
            
                <span>
            
                    
                    TODO: Adding Support for New Architectures
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.7" data-path="angr_management.html">
            
                <a href="angr_management.html">
            
                    
                    Scripting angr management
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.7" data-path="examples.html">
            
                <a href="examples.html">
            
                    
                    Examples
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.8" >
            
                <span>
            
                    
                    Appendix
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.8.1" data-path="appendices/ops.html">
            
                <a href="appendices/ops.html">
            
                    
                    List of Claripy Operations
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.8.2" data-path="appendices/options.html">
            
                <a href="appendices/options.html">
            
                    
                    List of State Options
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.8.3" data-path="../CHANGELOG.html">
            
                <a href="../CHANGELOG.html">
            
                    
                    Changelog
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.8.4" data-path="../MIGRATION.html">
            
                <a href="../MIGRATION.html">
            
                    
                    Migrating to angr 8
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.8.5" data-path="migration-7.html">
            
                <a href="migration-7.html">
            
                    
                    Migrating to angr 7
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

    

    <li class="divider"></li>

    <li>
        <a href="https://www.gitbook.com" target="blank" class="gitbook-link">
            Published with GitBook
        </a>
    </li>
</ul>


                </nav>
            
        
    </div>

    <div class="book-body">
        
            <div class="body-inner">
                
                    

<div class="book-header" role="navigation">
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href=".." >Programming SimProcedures</a>
    </h1>
</div>




                    <div class="page-wrapper" tabindex="-1" role="main">
                        <div class="page-inner">
                            
<div id="book-search-results">
    <div class="search-noresults">
    
                                <section class="normal markdown-section">
                                
                                <h1 id="hooks-and-simprocedures-in-detail">Hooks and SimProcedures in Detail</h1>
<p>Hooks in angr are very powerful!
You can use them to modify a program&apos;s behavior in any way you could imagine.
However, the exact way you might want to program a specific hook may be non-obvious.
This chapter should serve as a guide when programming SimProcedures.</p>
<h2 id="quick-start">Quick Start</h2>
<p>Here&apos;s an example that will remove all bugs from any program:</p>
<pre><code class="lang-python"><span class="hljs-meta">&gt;&gt;&gt; </span><span class="hljs-keyword">from</span> angr <span class="hljs-keyword">import</span> Project, SimProcedure
<span class="hljs-meta">&gt;&gt;&gt; </span>project = Project(<span class="hljs-string">&apos;examples/fauxware/fauxware&apos;</span>)

<span class="hljs-meta">&gt;&gt;&gt; </span><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">BugFree</span><span class="hljs-params">(SimProcedure)</span>:</span>
<span class="hljs-meta">... </span>   <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">run</span><span class="hljs-params">(self, argc, argv)</span>:</span>
<span class="hljs-meta">... </span>       print(<span class="hljs-string">&apos;Program running with argc=%s and argv=%s&apos;</span> % (argc, argv))
<span class="hljs-meta">... </span>       <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>

<span class="hljs-comment"># this assumes we have symbols for the binary</span>
<span class="hljs-meta">&gt;&gt;&gt; </span>project.hook_symbol(<span class="hljs-string">&apos;main&apos;</span>, BugFree())

<span class="hljs-comment"># Run a quick execution!</span>
<span class="hljs-meta">&gt;&gt;&gt; </span>simgr = project.factory.simulation_manager()
<span class="hljs-meta">&gt;&gt;&gt; </span>simgr.run()  <span class="hljs-comment"># step until no more active states</span>
Program running <span class="hljs-keyword">with</span> argc=&lt;SAO &lt;BV64 <span class="hljs-number">0x0</span>&gt;&gt; <span class="hljs-keyword">and</span> argv=&lt;SAO &lt;BV64 <span class="hljs-number">0x7fffffffffeffa0</span>&gt;&gt;
&lt;SimulationManager <span class="hljs-keyword">with</span> <span class="hljs-number">1</span> deadended&gt;
</code></pre>
<p>Now, whenever program execution reaches the main function, instead of executing the actual main function, it will execute this procedure!
It just prints out a message, and returns.</p>
<p>Now, let&apos;s talk about what happens on the edge of this function!
When entering the function, where do the values that go into the arguments come from?
You can define your <code>run()</code> function with however many arguments you like, and the SimProcedure runtime will automatically extract from the program state those arguments for you, via a <a href="structured_data.html#working-with-calling-conventions">calling convention</a>, and call your run function with them. Similarly, when you return a value from the run function, it is placed into the state (again, according to the calling convention), and the actual control-flow action of returning from a function is performed, which depending on the architecture may involve jumping to the link register or jumping to the result of a stack pop.</p>
<p>It should be clear at this point that the SimProcedure we just wrote is meant to totally replace whatever function it is hooked over top of.
In fact, the original use case for SimProcedures was replacing library functions.
More on that later.</p>
<h2 id="implementation-context">Implementation Context</h2>
<p>On a <code>Project</code> class, the dict <code>project._sim_procedures</code> is a mapping from address to <code>SimProcedure</code> instances.
When the <a href="pipeline.html">execution pipeline</a> reaches an address that is present in that dict, that is, an address that is hooked, it will execute <code>project._sim_procedures[address].execute(state)</code>.
This will consult the calling convention to extract the arguments, make a copy of itself in order to preserve thread safety, and run the <code>run()</code> method.
It is important to produce a new instance of the SimProcedure for each time it is run, since the process of running a SimProcedure necessarily involves mutating state on the SimProcedure instance, so we need separate ones for each step, lest we run into race conditions in multithreaded environments.</p>
<h3 id="kwargs">kwargs</h3>
<p>This hierarchy implies that you might want to reuse a single SimProcedure in multiple hooks.
What if you want to hook the same SimProcedure in several places, but tweaked slightly each time?
angr&apos;s support for this is that any additional keyword arguments you pass to the constructor of your SimProcedure will end up getting passed as keyword args to your SimProcedure&apos;s <code>run()</code> method.
Pretty cool!</p>
<h2 id="data-types">Data Types</h2>
<p>If you were paying attention to the example earlier, you noticed that when we printed out the arguments to the <code>run()</code> function, they came out as a weird <code>&lt;SAO &lt;BV64 0xSTUFF&gt;&gt;</code> class.
This is a <code>SimActionObject</code>.
Basically, you don&apos;t need to worry about it too much, it&apos;s just a thin wrapper over a normal bitvector.
It does a bit of tracking of what exactly you do with it inside the SimProcedure---this is helpful for static analysis.</p>
<p>You may also have noticed that we directly returned the python int <code>0</code> from the procedure.
This will automatically be promoted to a word-sized bitvector!
You can return a native number, a bitvector, or a SimActionObject.</p>
<p>When you want to write a procedure that deals with floating point numbers, you will need to specify the calling convention manually.
It&apos;s not too hard, just provide a cc to the hook: <a href="http://angr.io/api-doc/angr.html#angr.factory.AngrObjectFactory.cc_from_arg_kinds" target="_blank"><code>cc = project.factory.cc_from_arg_kinds((True, True), ret_fp=True)</code></a> and <code>project.hook(address, ProcedureClass(cc=mycc))</code>
This method for passing in a calling convention works for all calling conventions, so if angr&apos;s autodetected one isn&apos;t right, you can fix that.</p>
<h2 id="control-flow">Control Flow</h2>
<p>How can you exit a SimProcedure?
We&apos;ve already gone over the simplest way to do this, returning a value from <code>run()</code>.
This is actually shorthand for calling <code>self.ret(value)</code>.
<code>self.ret()</code> is the function which knows how to perform the specific action of returning from a function.</p>
<p>SimProcedures can use lots of different functions like this!</p>
<ul>
<li><code>ret(expr)</code>: Return from a function</li>
<li><code>jump(addr)</code>: Jump to an address in the binary</li>
<li><code>exit(code)</code>: Terminate the program</li>
<li><code>call(addr, args, continue_at)</code>: Call a function in the binary</li>
<li><code>inline_call(procedure, *args)</code>: Call another SimProcedure in-line and return the results</li>
</ul>
<p>That second-last one deserves some looking-at.
We&apos;ll get there after a quick detour...</p>
<h3 id="conditional-exits">Conditional Exits</h3>
<p>What if we want to add a conditional branch out of a SimProcedure?
In order to do that, you&apos;ll need to work directly with the SimSuccessors object for the current execution step.</p>
<p>The interface for this is <a href="http://angr.io/api-doc/angr.html#angr.engines.successors.SimSuccessors.add_successor" target="_blank"><code>self.successors.add_successor(state, addr, guard, jumpkind)</code></a>.
All of these parameters should have an obvious meaning if you&apos;ve followed along so far.
Keep in mind that the state you pass in will NOT be copied and WILL be mutated, so be sure to make a copy beforehand if there will be more work to do!</p>
<h3 id="simprocedure-continuations">SimProcedure Continuations</h3>
<p>How can we call a function in the binary and have execution resume within our SimProcedure?
There is a whole bunch of infrastructure called the &quot;SimProcedure Continuation&quot; that will let you do this.
When you use <code>self.call(addr, args, continue_at)</code>, <code>addr</code> is expected to be the address you&apos;d like to call, <code>args</code> is the tuple of arguments you&apos;d like to call it with, and <code>continue_at</code> is the name of another method in your SimProcedure class that you&apos;d like execution to continue at when it returns.
This method must have the same signature as the <code>run()</code> method.
Furthermore, you can pass the keyword argument <code>cc</code> as the calling convention that ought to be used to communicate with the callee.</p>
<p>When you do this, you finish your current step, and execution will start again at the next step at the function you&apos;ve specified.
When that function returns, it has to return to some concrete address!
That address is specified by the SimProcedure runtime: an address is allocated in angr&apos;s externs segment to be used as the return site for returning to the given method call.
It is then hooked with a copy of the procedure instance tweaked to run the specified <code>continue_at</code> function instead of <code>run()</code>, with the same args and kwargs as the first time.</p>
<p>There are two pieces of metadata you need to attach to your SimProcedure class in order to use the continuation subsystem correctly:</p>
<ul>
<li>Set the class variable <code>IS_FUNCTION = True</code></li>
<li>Set the class variable <code>local_vars</code> to a tuple of strings, where each string is the name of an instance variable on your SimProcedure whose value you would like to persist to when you return.
Local variables can be any type so long as you don&apos;t mutate their instances.</li>
</ul>
<p>You may have guessed by now that there exists some sort of auxiliary storage in order to hold on to all this data.
You would be right!
The state plugin <code>state.callstack</code> has an entry called <code>.procedure_data</code> which is used by the SimProcedure runtime to store information local to the current call frame.
angr tracks the stack pointer in order to make the current top of the <code>state.callstack</code> a meaningful local data store.
It&apos;s stuff that ought to be stored in memory in a stack frame, but the data can&apos;t be serialized and/or memory allocation is hard.</p>
<p>As an example, let&apos;s look at the SimProcedure that angr uses internally to run all the shared library initializers for a <code>full_init_state</code> for a linux program:</p>
<pre><code class="lang-python"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">LinuxLoader</span><span class="hljs-params">(angr.SimProcedure)</span>:</span>
    NO_RET = <span class="hljs-keyword">True</span>
    IS_FUNCTION = <span class="hljs-keyword">True</span>
    local_vars = (<span class="hljs-string">&apos;initializers&apos;</span>,)

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">run</span><span class="hljs-params">(self)</span>:</span>
        self.initializers = self.project.loader.initializers
        self.run_initializer()

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">run_initializer</span><span class="hljs-params">(self)</span>:</span>
        <span class="hljs-keyword">if</span> len(self.initializers) == <span class="hljs-number">0</span>:
            self.project._simos.set_entry_register_values(self.state)
            self.jump(self.project.entry)
        <span class="hljs-keyword">else</span>:
            addr = self.initializers[<span class="hljs-number">0</span>]
            self.initializers = self.initializers[<span class="hljs-number">1</span>:]
            self.call(addr, (self.state.posix.argc, self.state.posix.argv, self.state.posix.environ), <span class="hljs-string">&apos;run_initializer&apos;</span>)
</code></pre>
<p>This is a particularly clever usage of the SimProcedure continuations.
First, notice that the current project is available for use on the procedure instance.
This is some powerful stuff you can get yourself into; for safety you generally only want to use the project as a read-only or append-only data structure.
Here we&apos;re just getting the list of dynamic intializers from the loader.
Then, for as long as the list isn&apos;t empty, we pop a single function pointer out of the list, being careful not to mutate the list, since the list object is shared across states, and then call it, returning to the <code>run_initializer</code> function again.
When we run out of initializers, we set up the entry state and jump to the program entry point.</p>
<p>Very cool!</p>
<h2 id="global-variables">Global Variables</h2>
<p>As a brief aside, you can store global variables in <code>state.globals</code>.
This is a dictionary that just gets shallow-copied from state to successor state.
Because it&apos;s only a shallow copy, its members are the same instances, so the same rules as local variables in SimProcedure continuations apply.
You need to be careful not to mutate any item that is used as a global variable unless you know exactly what you&apos;re doing.</p>
<h2 id="helping-out-static-analysis">Helping out static analysis</h2>
<p>We&apos;ve already looked at the class variable <code>IS_FUNCTION</code>, which allows you to use the SimProcedure continuation.
There are a few more class variables you can set, though these ones have no direct benefit to you - they merely mark attributes of your function so that static analysis knows what it&apos;s doing.</p>
<ul>
<li><code>NO_RET</code>: Set this to true if control flow will never return from this function</li>
<li><code>ADDS_EXITS</code>: Set this to true if you do any control flow other than returning</li>
<li><code>IS_SYSCALL</code>: Self-explanatory</li>
</ul>
<p>Furthermore, if you set <code>ADDS_EXITS</code>, you may also want to define the method <code>static_exits()</code>.
This function takes a single parameter, a list of IRSBs that would be executed in the run-up to your function, and asks you to return a list of all the exits that you know would be produced by your function in that case.
The return value is expected to be a list of tuples of (address (int), jumpkind (str)).
This is meant to be a quick, best-effort analysis, and you shouldn&apos;t try to do anything crazy or intensive to get your answer.</p>
<h2 id="user-hooks">User Hooks</h2>
<p>The process of writing and using a SimProcedure makes a lot of assumptions that you want to hook over a whole function.
What if you don&apos;t?
There&apos;s an alternate interface for hooking, a <em>user hook</em>, that lets you streamline the process of hooking sections of code.</p>
<pre><code class="lang-python"><span class="hljs-meta">&gt;&gt;&gt; </span>@project.hook(<span class="hljs-number">0x1234</span>, length=<span class="hljs-number">5</span>)
<span class="hljs-meta">... </span><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">set_rax</span><span class="hljs-params">(state)</span>:</span>
<span class="hljs-meta">... </span>    state.regs.rax = <span class="hljs-number">1</span>
</code></pre>
<p>This is a lot simpler!
The idea is to use a single function instead of an entire SimProcedure subclass.
No extraction of arguments is performed, no complex control flow happens.</p>
<p>Control flow is controlled by the length argument.
After the function finishes executing in this example, the next step will start at 5 bytes after the hooked address.
If the length argument is omitted or set to zero, execution will resume executing the binary code at exactly the hooked address, without re-triggering the hook.
The <code>Ijk_NoHook</code> jumpkind allows this to happen.</p>
<p>If you want more control over control flow coming out of a user hook, you can return a list of successor states.
Each successor will be expected to have <code>state.regs.ip</code>, <code>state.scratch.guard</code>, and <code>state.scratch.jumpkind</code> set.
The IP is the target instruction pointer, the guard is a symbolic boolean representing a constraint to add to the state related to it being taken as opposed to the others, and the jumpkind is a VEX enum string, like <code>Ijk_Boring</code>, representing the nature of the branch.</p>
<p>The general rule is, if you want your SimProcedure to either be able to extract function arguments or cause a program return, write a full SimProcedure class.
Otherwise, use a user hook.</p>
<h2 id="hooking-symbols">Hooking Symbols</h2>
<p>As you should recall from the <a href="loading.html">section on loading a binary</a>, dynamically linked programs have a list of symbols that they must import from the libraries they have listed as dependencies, and angr will make sure, rain or shine, that every import symbol gets resolved by <em>some</em> address, whether it&apos;s a real implementaion of the function or just a dummy address hooked with a do-nothing stub.
As a result, you can just use the <code>Project.hook_symbol</code> API to hook the address referred to by a symbol!</p>
<p>This means that you can replace library functions with your own code.
For instance, to replace <code>rand()</code> with a function that always returns a consistent sequence of values:</p>
<pre><code class="lang-python"><span class="hljs-meta">&gt;&gt;&gt; </span><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">NotVeryRand</span><span class="hljs-params">(SimProcedure)</span>:</span>
<span class="hljs-meta">... </span>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">run</span><span class="hljs-params">(self, return_values=None)</span>:</span>
<span class="hljs-meta">... </span>        rand_idx = self.state.globals.get(<span class="hljs-string">&apos;rand_idx&apos;</span>, <span class="hljs-number">0</span>) % len(return_values)
<span class="hljs-meta">... </span>        out = return_values[rand_idx]
<span class="hljs-meta">... </span>        self.state.globals[<span class="hljs-string">&apos;rand_idx&apos;</span>] = rand_idx + <span class="hljs-number">1</span>
<span class="hljs-meta">... </span>        <span class="hljs-keyword">return</span> out

<span class="hljs-meta">&gt;&gt;&gt; </span>project.hook_symbol(<span class="hljs-string">&apos;rand&apos;</span>, NotVeryRand(return_values=[<span class="hljs-number">413</span>, <span class="hljs-number">612</span>, <span class="hljs-number">1025</span>, <span class="hljs-number">1111</span>]))
</code></pre>
<p>Now, whenever the program tries to call <code>rand()</code>, it&apos;ll return the integers from the <code>return_values</code> array in a loop.</p>

                                
                                </section>
                            
    </div>
    <div class="search-results">
        <div class="has-results">
            
            <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
            <ul class="search-results-list"></ul>
            
        </div>
        <div class="no-results">
            
            <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
            
        </div>
    </div>
</div>

                        </div>
                    </div>
                
            </div>

            
                
                
                <a href="state_plugins.html" class="navigation navigation-next navigation-unique" aria-label="Next page: Writing State Plugins">
                    <i class="fa fa-angle-right"></i>
                </a>
                
            
        
    </div>

    <script>
        var gitbook = gitbook || [];
        gitbook.push(function() {
            gitbook.page.hasChanged({"page":{"title":"Programming SimProcedures","level":"1.6.1","depth":2,"next":{"title":"Writing State Plugins","level":"1.6.2","depth":2,"path":"docs/state_plugins.md","ref":"docs/state_plugins.md","articles":[]},"previous":{"title":"Extending angr","level":"1.6","depth":1,"ref":"","articles":[{"title":"Programming SimProcedures","level":"1.6.1","depth":2,"path":"docs/simprocedures.md","ref":"docs/simprocedures.md","articles":[]},{"title":"Writing State Plugins","level":"1.6.2","depth":2,"path":"docs/state_plugins.md","ref":"docs/state_plugins.md","articles":[]},{"title":"Extending the Environment Model","level":"1.6.3","depth":2,"path":"docs/environment.md","ref":"docs/environment.md","articles":[]},{"title":"TODO: Writing Exploration Techniques","level":"1.6.4","depth":2,"path":"docs/exploration_techniques.md","ref":"docs/exploration_techniques.md","articles":[]},{"title":"Writing Analyses","level":"1.6.5","depth":2,"path":"docs/analysis_writing.md","ref":"docs/analysis_writing.md","articles":[]},{"title":"TODO: Adding Support for New Architectures","level":"1.6.6","depth":2,"path":"docs/angr-bf.md","ref":"docs/angr-bf.md","articles":[]},{"title":"Scripting angr management","level":"1.6.7","depth":2,"path":"docs/angr_management.md","ref":"docs/angr_management.md","articles":[]}]},"dir":"ltr"},"config":{"gitbook":"*","theme":"default","variables":{},"plugins":[],"pluginsConfig":{"highlight":{},"search":{},"lunr":{"maxIndexSize":1000000,"ignoreSpecialCharacters":false},"sharing":{"facebook":true,"twitter":true,"google":false,"weibo":false,"instapaper":false,"vk":false,"all":["facebook","google","twitter","weibo","instapaper"]},"fontsettings":{"theme":"white","family":"sans","size":2},"theme-default":{"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"showLevel":false}},"structure":{"langs":"LANGS.md","readme":"README.md","glossary":"GLOSSARY.md","summary":"SUMMARY.md"},"pdf":{"pageNumbers":true,"fontSize":12,"fontFamily":"Arial","paperSize":"a4","chapterMark":"pagebreak","pageBreaksBefore":"/","margin":{"right":62,"left":62,"top":56,"bottom":56}},"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"}},"file":{"path":"docs/simprocedures.md","mtime":"2021-07-15T09:05:26.000Z","type":"markdown"},"gitbook":{"version":"3.2.3","time":"2021-08-01T08:40:14.923Z"},"basePath":"..","book":{"language":""}});
        });
    </script>
</div>

        
    <script src="../gitbook/gitbook.js"></script>
    <script src="../gitbook/theme.js"></script>
    
        
        <script src="../gitbook/gitbook-plugin-search/search-engine.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-search/search.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-lunr/lunr.min.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-lunr/search-lunr.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-sharing/buttons.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-fontsettings/fontsettings.js"></script>
        
    

    </body>
</html>

